<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Green Gathering Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after {
  box-sizing: border-box; margin: 0; padding: 0;
  -webkit-tap-highlight-color: transparent;
}

:root {
  --font: 'Nunito', 'Noto Sans JP', sans-serif;

  /* â”€â”€ #005D4D ãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼ä½“ç³» â”€â”€ */
  --brand:      #005D4D;
  --brand-dark: #003D33;
  --brand-deep: #002820;
  --brand-mid:  #007A66;
  --brand-lit:  #00A88A;

  --bg-start:   #A8D8D0;
  --bg-end:     #7ABFB4;
  --body-bg:    #F0FBF9;
  --stage-a:    #D8F0EB;
  --stage-b:    #C4E8E0;
  --disp-bg:    #C8EDE8;
  --disp-bd:    #8ACDC4;

  --card-a:     #00B896;
  --card-b:     #007A66;
  --card-sh:    #004D40;

  --bn-a:       #00A070;
  --bn-b:       #007050;
  --bn-sh:      #004030;

  --op-bg:      #FFFFFF;
  --op-bd:      #A0D0C8;
  --op-tx:      #005D4D;

  --ut-a:       #70B8B0;
  --ut-b:       #4A9890;
  --ut-sh:      #2E7068;

  --eq-a:       #F05040;
  --eq-sh:      #A02010;

  --cl-a:       #9060D8;
  --cl-sh:      #5030A0;

  --ga-a:       #00A070;
  --ga-b:       #007050;
  --ga-sh:      #003828;

  --tax-a:      #50A890;
  --tax-b:      #388070;
  --tax-sh:     #205848;

  --td: #001A14;
  --tm: #003830;
  --tp: #48988A;
}

html, body {
  height: 100%;
  width: 100%;
}

body {
  font-family: var(--font);
  background: linear-gradient(150deg, var(--bg-start) 0%, var(--bg-end) 100%);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 20px 16px 40px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   é›»å“ã‚«ãƒ¼ãƒ‰ â€” å¹…ã‚’å³å¯†ã«ç®¡ç†
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.calc {
  background: var(--body-bg);
  width: 100%;
  max-width: 360px;           /* â˜… ä¸Šé™ã‚’æ˜ç¢ºã« */
  border-radius: 32px;
  padding: 18px 16px 22px;
  box-shadow:
    0 0 0 1.5px rgba(255,255,255,.9) inset,
    0 20px 56px rgba(0,25,20,.28),
    0 6px 16px rgba(0,25,20,.12);
  /* overflow:hidden ã§å­è¦ç´ ã®é£›ã³å‡ºã—ã‚’é˜²ã */
  overflow: hidden;
}

/* ã‚¿ã‚¤ãƒˆãƒ« */
.app-title {
  text-align: center;
  font-size: .58rem; font-weight: 900;
  letter-spacing: .25em; text-transform: uppercase;
  color: var(--tp); margin-bottom: 12px; user-select: none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ã‚«ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ â€” å›ºå®šé«˜ã•
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stage {
  position: relative;
  width: 100%;
  height: 262px;
  background: linear-gradient(140deg, var(--stage-a), var(--stage-b));
  border-radius: 18px;
  border: 2px dashed rgba(0,93,77,.2);
  margin-bottom: 8px;
  overflow: hidden;
}

.stage-hint {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%,-50%);
  text-align: center; pointer-events: none;
  transition: opacity .3s; user-select: none; width: 90%;
}
.stage-hint .si { font-size: 1.4rem; opacity: .25; display: block; margin-bottom: 4px; }
.stage-hint .st { font-size: .62rem; font-weight: 700; color: var(--tp); line-height: 1.8; }

/* â”€â”€ æ•°å­—ã‚«ãƒ¼ãƒ‰ â”€â”€ */
.ncard {
  position: absolute;
  background: linear-gradient(145deg, var(--card-a), var(--card-b));
  border-radius: 13px;
  padding: 7px 11px 7px 8px;
  min-width: 68px;
  box-shadow: 0 4px 0 var(--card-sh), 0 5px 12px rgba(0,35,25,.28);
  cursor: grab; user-select: none; touch-action: none;
  display: flex; align-items: center; gap: 4px;
  z-index: 10;
  transition: box-shadow .1s, transform .1s;
}
.ncard.dragging {
  cursor: grabbing;
  box-shadow: 0 7px 0 var(--card-sh), 0 12px 26px rgba(0,35,25,.4);
  transform: scale(1.07) rotate(-1.5deg);
  z-index: 80;
}
.ncard.enter   { animation: cIn  .32s cubic-bezier(.34,1.56,.64,1); }
.ncard.leaving { animation: cOut .18s ease-in forwards; }
@keyframes cIn  { from { transform: scale(.3) translateY(18px); opacity: 0; } to { transform: scale(1); opacity: 1; } }
@keyframes cOut { to   { transform: scale(.4); opacity: 0; } }

.clbl { font-size: .46rem; font-weight: 900; color: rgba(255,255,255,.55); letter-spacing: .06em; white-space: nowrap; }
.cval { font-size: 1.1rem; font-weight: 900; color: #fff; letter-spacing: -.02em; white-space: nowrap; flex: 1; text-align: right; }
.cdel {
  width: 16px; height: 16px;
  background: rgba(255,255,255,.2); border: none; border-radius: 50%;
  color: rgba(255,255,255,.8); font-size: .55rem; font-weight: 900;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; line-height: 1; transition: background .12s;
}
.cdel:hover { background: rgba(220,50,30,.55); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   é›†è¨ˆçµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸å†…ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.result-overlay {
  position: absolute; inset: 0;
  background: rgba(210,245,238,.95);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border-radius: 16px;
  display: flex; flex-direction: column;
  justify-content: center;
  padding: 14px 16px 12px;
  z-index: 200;
  opacity: 0; pointer-events: none;
  transform: scale(.95);
  transition: opacity .26s ease, transform .26s cubic-bezier(.34,1.3,.64,1);
}
.result-overlay.show { opacity: 1; pointer-events: auto; transform: scale(1); }

.ro-label {
  font-size: .52rem; font-weight: 900; letter-spacing: .18em;
  text-transform: uppercase; color: var(--tm); opacity: .55; margin-bottom: 4px;
}
.ro-formula {
  font-size: .76rem; font-weight: 700; color: var(--tm);
  line-height: 1.7; word-break: break-all; overflow-y: auto;
  max-height: 70px;
}
.ro-formula .pl { color: var(--brand-mid); font-weight: 900; margin: 0 2px; }
.ro-total {
  font-size: 1.85rem; font-weight: 900; color: var(--td);
  text-align: right; letter-spacing: -.03em;
  border-top: 1.5px solid rgba(0,93,77,.16);
  padding-top: 5px; margin-top: 5px; line-height: 1;
}
.ro-close {
  margin-top: 7px; display: block; width: 100%;
  background: rgba(0,93,77,.1); border: none; border-radius: 9px;
  padding: 5px; font-family: var(--font); font-size: .64rem; font-weight: 800;
  color: var(--tm); cursor: pointer; transition: background .13s;
}
.ro-close:hover { background: rgba(0,93,77,.22); }

/* total-bar å‰Šé™¤æ¸ˆ */

/* ã‚«ãƒ¼ãƒ‰æšæ•°ãƒãƒƒã‚¸ */
.card-count {
  position: absolute;
  top: 10px; right: 12px;
  background: rgba(0,93,77,.18);
  border-radius: 20px;
  padding: 3px 10px;
  font-size: .6rem; font-weight: 900;
  color: var(--tm);
  letter-spacing: .06em;
  pointer-events: none;
  z-index: 5;
  backdrop-filter: blur(4px);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼
   C(56px) | display(flex:1) | gather(56px)
   â€» å›ºå®špx + 1fræ§‹æˆ â†’ å¹…ãŒç¢ºå®š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ctrl {
  width: 100%;
  display: grid;
  grid-template-columns: 56px 1fr 56px;
  gap: 8px;
  align-items: center;
  margin-bottom: 11px;
}

/* ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ */
.disp {
  background: var(--disp-bg);
  border: 2px solid var(--disp-bd);
  border-radius: 16px;
  height: 56px;
  padding: 4px 13px;
  display: flex; flex-direction: column;
  justify-content: center; align-items: flex-end;
  overflow: hidden;
  cursor: grab; user-select: none; touch-action: none;
  transition: transform .12s, box-shadow .12s, border-color .13s;
  min-width: 0;   /* â† gridå†…ã§ã®ã¯ã¿å‡ºã—é˜²æ­¢ */
}
.disp:hover   { border-color: var(--brand-mid); box-shadow: 0 0 0 3px rgba(0,93,77,.12); }
.disp.lift    { cursor: grabbing; transform: scale(1.04) translateY(-3px); box-shadow: 0 10px 24px rgba(0,35,25,.26); border-color: var(--brand); }

.d-expr { font-size: .55rem; font-weight: 600; color: var(--tp); min-height: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
.d-num  {
  font-size: 1.75rem; font-weight: 900; color: var(--td);
  letter-spacing: -.03em; white-space: nowrap; overflow: hidden;
  text-overflow: ellipsis; max-width: 100%; line-height: 1.05;
  transition: font-size .1s;
}
.d-num.sm { font-size: 1.35rem; }
.d-num.xs { font-size: 1rem; }
@keyframes dfl { 0%,100%{background:var(--disp-bg)} 40%{background:#80DDD0} }
.disp.flash { animation: dfl .38s ease; }

/* ã‚´ãƒ¼ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ */
.ghost-card {
  position: fixed; pointer-events: none; z-index: 9999;
  background: linear-gradient(145deg, var(--card-a), var(--card-b));
  border-radius: 13px; padding: 7px 14px;
  font-family: var(--font); font-size: 1.1rem; font-weight: 900; color: #fff;
  box-shadow: 0 8px 20px rgba(0,35,25,.42);
  transform: scale(1.06) rotate(-2deg); opacity: .88; white-space: nowrap;
}

.stage.drop-ready {
  border-color: rgba(0,93,77,.48);
  background: linear-gradient(140deg, #B8EAE4, #A0E0D8);
  box-shadow: inset 0 0 16px rgba(0,93,77,.1);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ãƒœã‚¿ãƒ³å…±é€š
   â˜… width/height ã‚’å›ºå®špx(56px)ã«çµ±ä¸€
     â†’ vwä¾å­˜ã‚’ã‚„ã‚ã¦ã¯ã¿å‡ºã—ã‚¼ãƒ­ã«
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
  border: none; border-radius: 50%;
  width: 56px; height: 56px;
  font-family: var(--font);
  font-size: 1rem; font-weight: 800;
  cursor: pointer;
  display: flex; justify-content: center; align-items: center;
  margin: 0 auto;
  user-select: none; flex-shrink: 0;
  transition: transform .08s ease, box-shadow .08s ease;
  -webkit-tap-highlight-color: transparent;
}
.btn:active { transform: scale(.87) translateY(2px); }

/* æ•°å­—ï¼š#005D4D ç³» */
.bn {
  background: linear-gradient(170deg, var(--bn-a), var(--bn-b));
  color: #fff; font-size: 1.45rem;
  box-shadow: 0 4px 0 var(--bn-sh), 0 5px 13px rgba(0,35,25,.32);
}
.bn:active { box-shadow: 0 1px 0 var(--bn-sh); }

/* æ¼”ç®—å­ï¼šç™½ */
.bop {
  background: var(--op-bg); color: var(--op-tx);
  font-size: 1.3rem;
  border: 2px solid var(--op-bd);
  box-shadow: 0 3px 0 #90C8C0, 0 4px 8px rgba(0,0,0,.06);
}
.bop:active { box-shadow: 0 1px 0 #90C8C0; }

/* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
.bu {
  background: linear-gradient(170deg, var(--ut-a), var(--ut-b));
  color: #fff; font-size: .92rem;
  box-shadow: 0 3px 0 var(--ut-sh), 0 4px 8px rgba(0,35,25,.22);
}
.bu:active { box-shadow: 0 1px 0 var(--ut-sh); }

/* Cï¼šãƒ‘ãƒ¼ãƒ—ãƒ« */
.bc {
  background: linear-gradient(170deg, var(--cl-a), #6040B8);
  color: #fff; font-size: 1.1rem;
  box-shadow: 0 4px 0 var(--cl-sh), 0 5px 13px rgba(70,30,130,.34);
}
.bc:active { box-shadow: 0 1px 0 var(--cl-sh); }

/* ï¼ï¼šã‚³ãƒ¼ãƒ©ãƒ« */
.beq {
  background: linear-gradient(170deg, var(--eq-a), #C02810);
  color: #fff; font-size: 1.4rem;
  box-shadow: 0 4px 0 var(--eq-sh), 0 5px 13px rgba(200,50,30,.36);
}
.beq:active { box-shadow: 0 1px 0 var(--eq-sh); }

/* â˜… é›†è¨ˆãƒœã‚¿ãƒ³ï¼šã€Œã¾ã¨ã‚ã‚‹ã€ã‚’ç›´æ„Ÿçš„ã«ä¼ãˆã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³ */
.bga {
  background: linear-gradient(170deg, var(--ga-a), var(--ga-b));
  color: #fff;
  box-shadow: 0 4px 0 var(--ga-sh), 0 6px 14px rgba(0,30,20,.38);
  position: relative;
}
.bga:active { box-shadow: 0 1px 0 var(--ga-sh); }

/* é›†è¨ˆã‚¢ã‚¤ã‚³ãƒ³ï¼šå†…å‘ãçŸ¢å°4æœ¬ + ä¸­å¤®ã®åˆè¨ˆè¨˜å· */
.gather-icon {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 1px;
  pointer-events: none;
}
.gi-top {
  font-size: .6rem; font-weight: 900; color: rgba(255,255,255,.85);
  letter-spacing: .04em; line-height: 1;
}
.gi-symbol {
  font-size: 1.3rem; font-weight: 900; color: #fff;
  line-height: 1; letter-spacing: -.04em;
}
.gi-bottom {
  font-size: .52rem; font-weight: 900; color: rgba(255,255,255,.75);
  letter-spacing: .03em; line-height: 1;
}

/* TAX */
.btax {
  background: linear-gradient(170deg, var(--tax-a), var(--tax-b));
  color: #fff; font-size: .72rem; letter-spacing: .03em;
  box-shadow: 0 3px 0 var(--tax-sh), 0 4px 9px rgba(0,35,25,.24);
}
.btax:active { box-shadow: 0 1px 0 var(--tax-sh); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰
   â˜… 5åˆ— Ã— 56px + gap4æœ¬ = 280 + 44 = 324px
     max-width 360px ã‹ã‚‰ padding 32px = 328px â† ã‚®ãƒªã‚®ãƒªåã¾ã‚‹
     gap ã‚’ 10px ã«èª¿æ•´: 280 + 40 = 320px âœ“
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.kpad {
  width: 100%;
  display: grid;
  grid-template-columns: repeat(5, 56px);
  gap: 10px;
  justify-content: center;   /* â˜… ä¸­å¤®æƒãˆ â†’ ã¯ã¿å‡ºã—ãªã— */
}

/* ãƒãƒƒãƒ— */
@keyframes tpop { 0%{transform:scale(1)} 45%{transform:scale(1.12)} 100%{transform:scale(1)} }
.t-val.pop { animation: tpop .2s ease-out; }
</style>
</head>
<body>
<div class="calc">

  <p class="app-title">Green Gathering Calculator</p>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¸ -->
  <div class="stage" id="stage">
    <div class="stage-hint" id="stageHint">
      <span class="si">ğŸƒ</span>
      <span class="st">æ•°å­—ã‚’å…¥åŠ›ã—ã¦<br>ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚’<strong>ä¸Šã«ã‚¹ãƒ¯ã‚¤ãƒ—</strong>ã§ã‚«ãƒ¼ãƒ‰è¿½åŠ </span>
    </div>
    <!-- ã‚«ãƒ¼ãƒ‰æšæ•°ãƒãƒƒã‚¸ï¼ˆå³ä¸Šï¼‰ -->
    <div class="card-count" id="cardCount" style="display:none;">
      <span id="cardCountNum">0</span> ä»¶
    </div>
    <!-- é›†è¨ˆçµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="result-overlay" id="resultOverlay">
      <div class="ro-label">é›†è¨ˆçµæœ</div>
      <div class="ro-formula" id="roFormula"></div>
      <div class="ro-total"   id="roTotal"></div>
      <button class="ro-close" onclick="closeResult()">âœ• é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ -->
  <div class="ctrl">
    <button class="btn bc" onclick="clearAll()">C</button>
    <div class="disp" id="dispBox">
      <div class="d-expr" id="exprLine">&nbsp;</div>
      <div class="d-num"  id="numLine">0</div>
    </div>
    <!-- â˜… é›†è¨ˆãƒœã‚¿ãƒ³ï¼šÎ£ï¼ˆåˆè¨ˆè¨˜å·ï¼‰ã§ã€Œã¾ã¨ã‚ã‚‹ã€ã‚’ç›´æ„Ÿçš„ã«è¡¨ç¾ -->
    <button class="btn bga" onclick="gatherAll()" title="å…¨ã‚«ãƒ¼ãƒ‰ã‚’åˆè¨ˆ">
      <div class="gather-icon">
        <span class="gi-top">TOTAL</span>
        <span class="gi-symbol">Î£</span>
      </div>
    </button>
  </div>

  <!-- ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ -->
  <div class="kpad">
    <button class="btn bn"   onclick="inp('7')">7</button>
    <button class="btn bn"   onclick="inp('8')">8</button>
    <button class="btn bn"   onclick="inp('9')">9</button>
    <button class="btn bop"  onclick="setOp('Ã·')">Ã·</button>
    <button class="btn bu"   onclick="bspc()">âŒ«</button>

    <button class="btn bn"   onclick="inp('4')">4</button>
    <button class="btn bn"   onclick="inp('5')">5</button>
    <button class="btn bn"   onclick="inp('6')">6</button>
    <button class="btn bop"  onclick="setOp('Ã—')">Ã—</button>
    <button class="btn bu"   onclick="tglSign()">Â±</button>

    <button class="btn bn"   onclick="inp('1')">1</button>
    <button class="btn bn"   onclick="inp('2')">2</button>
    <button class="btn bn"   onclick="inp('3')">3</button>
    <button class="btn bop"  onclick="setOp('âˆ’')">âˆ’</button>
    <button class="btn bu"   onclick="pct()">%</button>

    <button class="btn bn"   onclick="inp('0')">0</button>
    <button class="btn bn"   onclick="inp('.')">.</button>
    <button class="btn beq"  onclick="calcOnly()">ï¼</button>
    <button class="btn bop"  onclick="setOp('ï¼‹')">ï¼‹</button>
    <button class="btn btax" onclick="doTax()">TAX</button>
  </div>

</div>

<script>
/* â•â• ã‚¹ãƒ†ãƒ¼ãƒˆ â•â• */
let cur='0', prev='', op=null, rst=false;

const NL  = document.getElementById('numLine');
const EL  = document.getElementById('exprLine');
const DB  = document.getElementById('dispBox');
const ST  = document.getElementById('stage');
const SH  = document.getElementById('stageHint');
const ROV = document.getElementById('resultOverlay');
const ROF = document.getElementById('roFormula');
const ROT = document.getElementById('roTotal');

let cards=[], cid=0;

function updD(v){
  const s=String(v);
  NL.textContent=s;
  NL.classList.remove('sm','xs');
  const l=s.replace(/[^0-9.]/g,'').length;
  if(l>12)NL.classList.add('xs');
  else if(l>8)NL.classList.add('sm');
}

function inp(ch){
  if(rst){cur='';rst=false;}
  if(cur==='0'&&ch!='.')cur='';
  if(ch==='.'&&cur.includes('.'))return;
  if(cur.replace('-','').length>=13)return;
  cur+=ch; if(!cur||cur==='-')cur='0';
  updD(cur);
}

function setOp(o){
  if(op&&!rst)calcOnly(true);
  prev=cur; op=o;
  EL.textContent=cur+' '+o;
  rst=true;
}

function calcOnly(chain){
  if(!op)return false;
  const p=parseFloat(prev), c=parseFloat(cur);
  if(isNaN(p)||isNaN(c))return false;
  let res;
  switch(op){
    case 'ï¼‹':res=p+c;break; case 'âˆ’':res=p-c;break;
    case 'Ã—':res=p*c;break;  case 'Ã·':res=c===0?null:p/c;break;
  }
  if(res===null){EL.textContent='0é™¤ç®—ã‚¨ãƒ©ãƒ¼';cur='0';op=null;updD('Error');return false;}
  res=parseFloat(res.toPrecision(12));
  EL.textContent=prev+' '+op+' '+cur+' ï¼';
  prev=String(res); cur=String(res);
  op=chain?op:null; rst=!chain;
  updD(res); return res;
}

function clearAll(){cur='0';prev='';op=null;rst=false;updD('0');EL.textContent='';}
function bspc(){if(rst)return;cur=cur.slice(0,-1)||'0';updD(cur);}
function tglSign(){const n=parseFloat(cur);if(!isNaN(n)&&n!==0){cur=String(n*-1);updD(cur);}}
function pct(){const n=parseFloat(cur);if(!isNaN(n)){cur=String(n/100);updD(cur);}}
function doTax(){
  const n=parseFloat(cur);if(isNaN(n))return;
  const r=Math.floor(n*1.1);
  EL.textContent=cur+'Ã—1.1ï¼ˆç¨10%ï¼‰ï¼';
  cur=String(r);rst=true;updD(r);
}

/* â•â• ã‚«ãƒ¼ãƒ‰è¿½åŠ  â•â• */
function addCard(value){
  cid++;
  const id=cid;
  const sw=ST.offsetWidth;
  const cw=Math.max(68, fmt(value).length*13+48);
  let x,y;
  if(cards.length===0){
    x=Math.min(8+Math.random()*28, sw-cw-8); y=8;
  } else {
    const last=cards[cards.length-1];
    x=last.x+10+Math.random()*18-9;
    y=last.y+46+Math.random()*6-3;
    x=Math.max(4,Math.min(x,sw-cw-6));
    y=Math.max(4,Math.min(y,ST.clientHeight-44-6));
  }
  const el=document.createElement('div');
  el.className='ncard enter';
  el.innerHTML=
    `<span class="clbl">#${id}</span>`+
    `<span class="cval">${fmt(value)}</span>`+
    `<button class="cdel" onclick="removeCard(${id})">âœ•</button>`;
  el.style.left=x+'px'; el.style.top=y+'px';
  ST.appendChild(el);
  const c={id,value,x,y,el};
  cards.push(c);
  el.addEventListener('animationend',()=>el.classList.remove('enter'),{once:true});
  makeDrag(el,c);
  updStage(); updTotal(); closeResult();
}

function removeCard(id){
  const i=cards.findIndex(c=>c.id===id);
  if(i<0)return;
  const {el}=cards[i];
  el.classList.add('leaving');
  setTimeout(()=>{el.remove();cards.splice(i,1);updStage();updTotal();},200);
}

function gatherAll(){
  if(cards.length===0)return;
  const cnt=cards.length;
  const sum=cards.reduce((a,c)=>a+c.value,0);
  const total=parseFloat(sum.toPrecision(12));
  let html='';
  cards.forEach((c,i)=>{
    if(i>0)html+=`<span class="pl"> ï¼‹ </span>`;
    html+=`<strong>${fmt(c.value)}</strong>`;
  });
  ROF.innerHTML=html+'<span class="pl"> ï¼ </span>';
  ROT.textContent=fmt(total);
  ROV.classList.add('show');
  cards.forEach(c=>c.el.classList.add('leaving'));
  setTimeout(()=>{cards.forEach(c=>c.el.remove());cards=[];updStage();updTotal();},210);
  cur=String(total);rst=true;op=null;
  updD(fmt(total));
  EL.textContent=cnt+'ä»¶ åˆè¨ˆ ï¼';
}

function closeResult(){ ROV.classList.remove('show'); }

function updStage(){
  SH.style.opacity = cards.length === 0 ? '1' : '0';
  const badge = document.getElementById('cardCount');
  const num   = document.getElementById('cardCountNum');
  if(cards.length === 0){
    badge.style.display = 'none';
  } else {
    badge.style.display = 'block';
    num.textContent = cards.length;
  }
}
function updTotal(){
  /* åˆè¨ˆãƒãƒ¼ã¯å»ƒæ­¢ã€‚é›†è¨ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã§ç¢ºèª */
}
function fmt(v){
  if(Number.isInteger(v))return v.toLocaleString('ja-JP');
  return parseFloat(v.toPrecision(10)).toLocaleString('ja-JP',{maximumFractionDigits:6});
}

/* â•â• ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ãƒ‰ãƒ©ãƒƒã‚° â†’ ã‚«ãƒ¼ãƒ‰è¿½åŠ  â•â• */
(function(){
  let dragging=false, ghost=null, startY=0;
  const THR=30;

  function getVal(){
    if(op&&!rst){const r=calcOnly(false);return r===false?null:r;}
    const n=parseFloat(cur); return isNaN(n)?null:n;
  }
  function mkGhost(val){
    const g=document.createElement('div');
    g.className='ghost-card'; g.textContent=fmt(val);
    document.body.appendChild(g); return g;
  }
  function mvGhost(cx,cy){
    if(!ghost)return;
    ghost.style.left=(cx-ghost.offsetWidth/2)+'px';
    ghost.style.top=(cy-ghost.offsetHeight/2)+'px';
  }
  function onStage(cx,cy){
    const r=ST.getBoundingClientRect();
    return cx>=r.left&&cx<=r.right&&cy>=r.top&&cy<=r.bottom;
  }
  function start(cx,cy){
    const val=getVal(); if(val===null)return;
    dragging=true; startY=cy;
    DB.classList.add('lift');
    ghost=mkGhost(val); mvGhost(cx,cy);
  }
  function move(cx,cy){
    if(!dragging)return;
    mvGhost(cx,cy);
    ST.classList.toggle('drop-ready', onStage(cx,cy)||cy<startY-THR);
  }
  function end(cx,cy){
    if(!dragging)return;
    dragging=false;
    DB.classList.remove('lift');
    ST.classList.remove('drop-ready');
    if(ghost){ghost.remove();ghost=null;}
    if(onStage(cx,cy)||cy<startY-THR){
      const val=getVal();
      if(val!==null){
        addCard(val);
        cur='0';rst=false;op=null;
        updD('0');EL.textContent='';
        DB.classList.remove('flash');void DB.offsetWidth;DB.classList.add('flash');
      }
    }
  }

  DB.addEventListener('mousedown',e=>{e.preventDefault();start(e.clientX,e.clientY);});
  document.addEventListener('mousemove',e=>move(e.clientX,e.clientY));
  document.addEventListener('mouseup',  e=>end(e.clientX,e.clientY));

  DB.addEventListener('touchstart',e=>{
    e.preventDefault();const t=e.touches[0];start(t.clientX,t.clientY);
  },{passive:false});
  document.addEventListener('touchmove',e=>{
    if(!dragging)return;e.preventDefault();
    const t=e.touches[0];move(t.clientX,t.clientY);
  },{passive:false});
  document.addEventListener('touchend',e=>{
    const t=e.changedTouches[0];end(t.clientX,t.clientY);
  });
})();

/* â•â• ã‚«ãƒ¼ãƒ‰ãƒ‰ãƒ©ãƒƒã‚° â•â• */
function makeDrag(el,card){
  let sx,sy,drag=false;
  el.addEventListener('mousedown',e=>{
    if(e.target.classList.contains('cdel'))return;
    e.preventDefault();drag=true;el.classList.add('dragging');
    const r=ST.getBoundingClientRect();
    sx=e.clientX-r.left-card.x;sy=e.clientY-r.top-card.y;
    front(el);
  });
  document.addEventListener('mousemove',e=>{if(!drag)return;mv(e.clientX,e.clientY,sx,sy,card,el);});
  document.addEventListener('mouseup',()=>{if(!drag)return;drag=false;el.classList.remove('dragging');});
  el.addEventListener('touchstart',e=>{
    if(e.target.classList.contains('cdel'))return;
    e.preventDefault();drag=true;el.classList.add('dragging');
    const r=ST.getBoundingClientRect(),t=e.touches[0];
    sx=t.clientX-r.left-card.x;sy=t.clientY-r.top-card.y;
    front(el);
  },{passive:false});
  document.addEventListener('touchmove',e=>{
    if(!drag)return;e.preventDefault();
    const t=e.touches[0];mv(t.clientX,t.clientY,sx,sy,card,el);
  },{passive:false});
  document.addEventListener('touchend',()=>{if(!drag)return;drag=false;el.classList.remove('dragging');});
}
function mv(cx,cy,sx,sy,card,el){
  const r=ST.getBoundingClientRect();
  let nx=cx-r.left-sx, ny=cy-r.top-sy;
  nx=Math.max(4,Math.min(nx,ST.clientWidth-el.offsetWidth-4));
  ny=Math.max(4,Math.min(ny,ST.clientHeight-el.offsetHeight-4));
  card.x=nx;card.y=ny;
  el.style.left=nx+'px';el.style.top=ny+'px';
}
function front(el){
  document.querySelectorAll('.ncard').forEach(c=>c.style.zIndex=10);
  el.style.zIndex=80;
}

updD('0');
</script>
</body>
</html>
