<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ÈõÜ„ÇÅ„ÇãÈõªÂçì">
<meta name="theme-color" content="#005D4D">
<title>ÈõÜ„ÇÅ„ÇãÈõªÂçì - Green Gathering Calculator</title>
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi6ZuG44KB44KL6Zu75Y2TIiwic2hvcnRfbmFtZSI6IumbhuOCgeOCi+mbu+WNkyIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMDA1RDREIiwidGhlbWVfY29sb3IiOiIjMDA1RDREIn0=">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<script>
// Generate app icon as canvas ‚Üí apple-touch-icon & favicon
(function generateAppIcon(){
  const sizes = [180, 192, 512];
  sizes.forEach(s => {
    const c = document.createElement('canvas');
    c.width = s; c.height = s;
    const ctx = c.getContext('2d');
    const r = s * 0.22; // corner radius

    // Rounded rect background
    ctx.beginPath();
    ctx.moveTo(r, 0);
    ctx.lineTo(s - r, 0); ctx.quadraticCurveTo(s, 0, s, r);
    ctx.lineTo(s, s - r); ctx.quadraticCurveTo(s, s, s - r, s);
    ctx.lineTo(r, s); ctx.quadraticCurveTo(0, s, 0, s - r);
    ctx.lineTo(0, r); ctx.quadraticCurveTo(0, 0, r, 0);
    ctx.closePath();
    const bg = ctx.createLinearGradient(0, 0, s, s);
    bg.addColorStop(0, '#00B896');
    bg.addColorStop(1, '#005D4D');
    ctx.fillStyle = bg;
    ctx.fill();

    const u = s / 100; // unit

    // Calculator body (white rounded rect)
    const bx = 22*u, by = 15*u, bw = 56*u, bh = 70*u, br = 8*u;
    ctx.beginPath();
    ctx.moveTo(bx+br, by);
    ctx.lineTo(bx+bw-br, by); ctx.quadraticCurveTo(bx+bw, by, bx+bw, by+br);
    ctx.lineTo(bx+bw, by+bh-br); ctx.quadraticCurveTo(bx+bw, by+bh, bx+bw-br, by+bh);
    ctx.lineTo(bx+br, by+bh); ctx.quadraticCurveTo(bx, by+bh, bx, by+bh-br);
    ctx.lineTo(bx, by+br); ctx.quadraticCurveTo(bx, by, bx+br, by);
    ctx.closePath();
    ctx.fillStyle = 'rgba(255,255,255,0.95)';
    ctx.fill();

    // Display screen
    ctx.fillStyle = '#C4EAE4';
    const dx = 27*u, dy = 20*u, dw = 46*u, dh = 16*u;
    roundRect(ctx, dx, dy, dw, dh, 4*u);
    ctx.fill();

    // Display text "7"
    ctx.fillStyle = '#003428';
    ctx.font = `bold ${11*u}px sans-serif`;
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    ctx.fillText('7', dx+dw-3*u, dy+dh/2+1*u);

    // Button grid (3x3)
    const btnColors = ['#00A070','#00A070','#00A070','#00A070','#00A070','#00A070','#00A070','#F04838','#8858D0'];
    const gx = 28*u, gy = 42*u, gs = 10*u, gg = 4*u;
    for(let row=0;row<3;row++){
      for(let col=0;col<3;col++){
        const idx = row*3+col;
        ctx.fillStyle = btnColors[idx];
        roundRect(ctx, gx+col*(gs+gg), gy+row*(gs+gg), gs, gs, 2.5*u);
        ctx.fill();
      }
    }

    // Gather arrows icon (top-right badge)
    const cx2 = 68*u, cy2 = 22*u, ar = 14*u;
    ctx.beginPath();
    ctx.arc(cx2, cy2, ar, 0, Math.PI*2);
    ctx.fillStyle = '#005D4D';
    ctx.fill();
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2*u;
    ctx.lineCap = 'round';
    // 4 arrows pointing inward
    const aOff = 6*u, aHead = 3*u;
    [[- 1,-1],[1,-1],[-1,1],[1,1]].forEach(([dx2,dy2])=>{
      const fx=cx2+dx2*aOff, fy=cy2+dy2*aOff;
      const tx=cx2+dx2*1.5*u, ty=cy2+dy2*1.5*u;
      ctx.beginPath(); ctx.moveTo(fx,fy); ctx.lineTo(tx,ty); ctx.stroke();
      // arrowhead
      ctx.beginPath(); ctx.moveTo(tx,ty);
      ctx.lineTo(tx+(-dx2)*aHead, ty);
      ctx.moveTo(tx,ty);
      ctx.lineTo(tx, ty+(-dy2)*aHead);
      ctx.stroke();
    });
    // center dot
    ctx.beginPath(); ctx.arc(cx2,cy2,2*u,0,Math.PI*2);
    ctx.fillStyle='#fff'; ctx.fill();

    const url = c.toDataURL('image/png');
    if(s === 180){
      const link = document.createElement('link');
      link.rel = 'apple-touch-icon';
      link.href = url;
      document.head.appendChild(link);
    }
    if(s === 192){
      const link = document.createElement('link');
      link.rel = 'icon';
      link.type = 'image/png';
      link.sizes = '192x192';
      link.href = url;
      document.head.appendChild(link);
    }
  });

  function roundRect(ctx, x, y, w, h, r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r);
    ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
    ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r);
    ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y);
    ctx.closePath();
  }
})();
</script>
<style>
*, *::before, *::after {
  box-sizing: border-box; margin: 0; padding: 0;
  -webkit-tap-highlight-color: transparent;
}

:root {
  --font:      'Nunito','Noto Sans JP',sans-serif;
  --brand:     #005D4D;  --brand-mid: #007A66;  --brand-deep: #002820;
  --bg-s:      #9CCEC6;  --bg-e:      #6AAFAA;
  --body-bg:   #F0FBF9;
  --stage-a:   #D4EEE9;  --stage-b:   #BFE4DC;
  --disp-bg:   #C4EAE4;  --disp-bd:   #84C8C0;
  --card-a:    #00B896;  --card-b:    #007A66;  --card-sh: #004D40;
  --bn-a:      #00A070;  --bn-b:      #006850;  --bn-sh:   #003828;
  --op-bg:     #FFFFFF;  --op-bd:     #9CCEC6;  --op-tx:   #005D4D;
  --ut-a:      #68B4AC;  --ut-b:      #46948C;  --ut-sh:   #2A6860;
  --eq-a:      #F04838;  --eq-sh:     #9E2010;
  --cl-a:      #8858D0;  --cl-sh:     #4C2898;
  --ga-a:      #009C6A;  --ga-b:      #006C48;  --ga-sh:   #003828;
  --tax-a:     #4CA488;  --tax-b:     #347C68;  --tax-sh:  #1C5040;
  --td:        #001A12;  --tm:        #003428;  --tp:      #469080;
}

html {
  height: 100%;
  overflow: hidden;
  scrollbar-width: none;
}
html::-webkit-scrollbar { display: none; }

body {
  font-family: var(--font);
  height: 100dvh;
  background: linear-gradient(150deg, var(--bg-s), var(--bg-e));
  background-attachment: fixed;
  display: flex;
  justify-content: center;
  align-items: stretch;
  padding: 0;
  overflow: hidden;
}

.calc {
  --gap: clamp(4px, 1.2vw, 8px);
  --btn: 56px; /* JS „Åß‰∏äÊõ∏„Åç„Åï„Çå„ÇãÂàùÊúüÂÄ§ */

  background: var(--body-bg);
  width: 100%;
  max-width: 540px;
  height: 100dvh;
  border-radius: 0;
  padding: clamp(6px, 1.2vh, 10px) clamp(8px, 1.4vw, 14px) clamp(6px, 1vh, 10px);
  display: flex;
  flex-direction: column;
  gap: clamp(4px, 0.7vh, 6px);
  box-shadow:
    0 0 0 1.5px rgba(255,255,255,.88) inset,
    0 20px 60px rgba(0,20,16,.28),
    0 6px 18px rgba(0,20,16,.12);
  overflow: hidden;
}

/* PCÂπÖ„ÅåÂ∫É„ÅÑÂ†¥Âêà„ÅÆ„ÅøËßí‰∏∏ */
@media (min-width: 560px) {
  body { align-items: center; padding: 12px; }
  .calc {
    height: min(98dvh, 920px);
    border-radius: 24px;
  }
}

.app-title {
  text-align: center;
  font-size: clamp(.7rem, 2vw, .9rem);
  font-weight: 900; letter-spacing: .23em; text-transform: uppercase;
  color: var(--tp); user-select: none; flex-shrink: 0;
  padding: clamp(2px, 0.4vh, 4px) 0;
}

/* ===== „Çπ„ÉÜ„Éº„Ç∏Ôºöflex-grow„Åß‰Ωô„Å£„ÅüÁ©∫Èñì„ÇíÂÖ®ÈÉ®‰Ωø„ÅÜ ===== */
.stage {
  position: relative;
  width: 100%;
  flex: 1 1 0;
  min-height: 80px;
  background: linear-gradient(138deg, var(--stage-a), var(--stage-b));
  border-radius: clamp(10px, 2.2vw, 18px);
  border: 2px dashed rgba(0,93,77,.2);
  overflow: hidden;
}

.stage-hint {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 6px;
  pointer-events: none; transition: opacity .28s; user-select: none;
}
.stage-hint .si {
  font-size: clamp(1.6rem, 5.5vw, 2.4rem); opacity: .22; line-height: 1;
}
.stage-hint .st {
  font-size: clamp(.78rem, 2.2vw, 1rem);
  font-weight: 700; color: var(--tp); line-height: 1.75; text-align: center;
}

/* ===== „Ç´„Éº„Éâ ===== */
.ncard {
  position: absolute;
  background: linear-gradient(145deg, var(--card-a), var(--card-b));
  border-radius: clamp(9px, 2vw, 14px);
  padding: clamp(7px,1.6vw,11px) clamp(12px,2.8vw,18px) clamp(7px,1.6vw,11px) clamp(8px,2vw,12px);
  min-width: clamp(72px, 16vw, 100px);
  box-shadow: 0 3px 0 var(--card-sh), 0 4px 10px rgba(0,30,20,.26);
  cursor: grab; user-select: none; touch-action: none;
  display: flex; align-items: center; gap: 5px;
  z-index: 10; transition: box-shadow .1s, transform .1s;
}
.ncard.dragging {
  cursor: grabbing;
  box-shadow: 0 6px 0 var(--card-sh), 0 10px 24px rgba(0,30,20,.38);
  transform: scale(1.07) rotate(-1.5deg); z-index: 80;
}
.ncard.enter   { animation: cIn  .3s cubic-bezier(.34,1.56,.64,1); }
.ncard.leaving { animation: cOut .17s ease-in forwards; }
@keyframes cIn  { from { transform:scale(.3) translateY(15px); opacity:0; } to { transform:scale(1); opacity:1; } }
@keyframes cOut { to   { transform:scale(.4); opacity:0; } }

.clbl { font-size: clamp(.55rem,1.2vw,.7rem); font-weight:900; color:rgba(255,255,255,.5); letter-spacing:.06em; white-space:nowrap; }
.cval { font-size: clamp(1.15rem,3.2vw,1.55rem); font-weight:900; color:#fff; letter-spacing:-.02em; white-space:nowrap; flex:1; text-align:right; }
.cdel {
  width: 20px; height: 20px; flex-shrink:0;
  background:rgba(255,255,255,.17); border:none; border-radius:50%;
  color:rgba(255,255,255,.76); font-size:.6rem; font-weight:900;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  line-height:1; transition:background .12s;
}
.cdel:hover { background:rgba(210,45,25,.5); }

.card-count {
  position:absolute; top:9px; right:11px; display:none;
  background:rgba(0,93,77,.13); border-radius:20px; padding:3px 11px;
  font-size:clamp(.62rem,1.5vw,.78rem); font-weight:900; color:var(--tm);
  letter-spacing:.05em; pointer-events:none; z-index:5;
}

/* ===== ÈõÜË®àÁµêÊûú„Ç™„Éº„Éê„Éº„É¨„Ç§ÔºàÊñáÂ≠óÂ§ß„Åç„ÅèÔºâ ===== */
.result-overlay {
  position:absolute; inset:0;
  background:rgba(208,244,236,.95);
  backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
  border-radius:inherit;
  display:flex; flex-direction:column; justify-content:center;
  padding: clamp(16px, 3.5vw, 28px);
  z-index:200; opacity:0; pointer-events:none; transform:scale(.94);
  transition:opacity .24s ease, transform .24s cubic-bezier(.34,1.3,.64,1);
}
.result-overlay.show { opacity:1; pointer-events:auto; transform:scale(1); }

.ro-label {
  font-size:clamp(.7rem, 1.8vw, .92rem); font-weight:900; letter-spacing:.15em;
  text-transform:uppercase; color:var(--tm); opacity:.5; margin-bottom:6px;
}
.ro-formula {
  font-size:clamp(1rem, 2.8vw, 1.4rem); font-weight:700; color:var(--tm);
  line-height:1.7; word-break:break-all; overflow-y:auto; max-height:40%;
}
.ro-formula .pl { color:var(--brand-mid); font-weight:900; margin:0 3px; }
.ro-total {
  font-size:clamp(2.4rem, 7vw, 3.6rem); font-weight:900; color:var(--td);
  text-align:right; letter-spacing:-.03em;
  border-top:2.5px solid rgba(0,93,77,.18);
  padding-top:8px; margin-top:8px; line-height:1.1;
}
.ro-buttons {
  margin-top:10px; display:flex; gap:8px;
}
.ro-use {
  flex:1; display:block;
  background:var(--brand-mid); border:none; border-radius:clamp(8px,1.8vw,12px);
  padding:clamp(8px,1.6vh,12px); font-family:var(--font);
  font-size:clamp(.78rem, 2vw, 1rem); font-weight:800; color:#fff;
  cursor:pointer; transition:background .13s;
}
.ro-use:hover { background:var(--brand); }
.ro-close {
  flex:1; display:block;
  background:rgba(0,93,77,.1); border:none; border-radius:clamp(8px,1.8vw,12px);
  padding:clamp(8px,1.6vh,12px); font-family:var(--font);
  font-size:clamp(.78rem, 2vw, 1rem); font-weight:800; color:var(--tm);
  cursor:pointer; transition:background .13s;
}
.ro-close:hover { background:rgba(0,93,77,.22); }

/* ===== „Ç≥„É≥„Éà„É≠„Éº„É´Ë°å ===== */
.ctrl {
  display: grid;
  grid-template-columns: var(--btn) 1fr var(--btn);
  gap: var(--gap);
  align-items: center;
  flex-shrink: 0;
}

/* ===== „Éá„Ç£„Çπ„Éó„É¨„Ç§ ===== */
.disp {
  background: var(--disp-bg);
  border: 2px solid var(--disp-bd);
  border-radius: clamp(10px, 2.2vw, 16px);
  height: var(--btn);
  padding: 4px clamp(10px, 2.4vw, 16px);
  display: flex; flex-direction: column;
  justify-content: center; align-items: flex-end;
  overflow: hidden;
  cursor: grab; user-select: none; touch-action: none;
  transition: transform .12s, box-shadow .12s, border-color .13s;
  min-width: 0;
}
.disp:hover  { border-color: var(--brand-mid); box-shadow: 0 0 0 3px rgba(0,93,77,.1); }
.disp.lift   { cursor:grabbing; transform:scale(1.03) translateY(-3px); box-shadow:0 9px 22px rgba(0,30,20,.24); border-color:var(--brand); }

.d-expr {
  font-size: clamp(.62rem, 1.7vw, .82rem); font-weight:600; color:var(--tp);
  min-height:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%;
}
.d-num {
  font-size: clamp(1.9rem, 5.8vw, 2.7rem); font-weight:900; color:var(--td);
  letter-spacing:-.03em; white-space:nowrap; overflow:hidden;
  text-overflow:ellipsis; max-width:100%; line-height:1.08; transition:font-size .1s;
}
.d-num.sm { font-size: clamp(1.5rem, 4.4vw, 2rem); }
.d-num.xs { font-size: clamp(1.1rem, 3.2vw, 1.45rem); }
@keyframes dfl { 0%,100%{background:var(--disp-bg)} 40%{background:#78D8CC} }
.disp.flash { animation:dfl .36s ease; }

.ghost-card {
  position:fixed; pointer-events:none; z-index:9999;
  background:linear-gradient(145deg,var(--card-a),var(--card-b));
  border-radius:clamp(9px,2vw,14px); padding:clamp(7px,1.6vw,11px) clamp(12px,2.8vw,18px);
  font-family:var(--font); font-size:clamp(1.15rem,3.2vw,1.55rem); font-weight:900; color:#fff;
  box-shadow:0 7px 18px rgba(0,30,20,.4); transform:scale(1.06) rotate(-2deg); opacity:.87; white-space:nowrap;
}
.stage.drop-ready {
  border-color:rgba(0,93,77,.45);
  background:linear-gradient(138deg,#B4E8E0,#9CDDD4);
  box-shadow:inset 0 0 13px rgba(0,93,77,.1);
}

/* ===== „Éú„Çø„É≥ ===== */
.btn {
  border:none; border-radius:50%;
  width:var(--btn); height:var(--btn);
  font-family:var(--font); font-weight:800;
  cursor:pointer;
  display:flex; justify-content:center; align-items:center;
  margin:0 auto; user-select:none; flex-shrink:0;
  transition:transform .08s ease, box-shadow .08s ease;
}
.btn:active { transform:scale(.86) translateY(2px); }

.bn  { background:linear-gradient(170deg,var(--bn-a),var(--bn-b)); color:#fff; font-size:calc(var(--btn)*.46); box-shadow:0 4px 0 var(--bn-sh),0 5px 12px rgba(0,30,20,.3); }
.bn:active  { box-shadow:0 1px 0 var(--bn-sh); }
.bop { background:var(--op-bg); color:var(--op-tx); font-size:calc(var(--btn)*.42); border:2px solid var(--op-bd); box-shadow:0 3px 0 #88C0B8,0 4px 8px rgba(0,0,0,.06); }
.bop:active { box-shadow:0 1px 0 #88C0B8; }
.bu  { background:linear-gradient(170deg,var(--ut-a),var(--ut-b)); color:#fff; font-size:calc(var(--btn)*.33); box-shadow:0 3px 0 var(--ut-sh),0 4px 8px rgba(0,30,20,.2); }
.bu:active  { box-shadow:0 1px 0 var(--ut-sh); }
.bc  { background:linear-gradient(170deg,var(--cl-a),#5A38B0); color:#fff; font-size:calc(var(--btn)*.36); box-shadow:0 4px 0 var(--cl-sh),0 5px 12px rgba(60,25,120,.32); }
.bc:active  { box-shadow:0 1px 0 var(--cl-sh); }
.beq { background:linear-gradient(170deg,var(--eq-a),#B82008); color:#fff; font-size:calc(var(--btn)*.44); box-shadow:0 4px 0 var(--eq-sh),0 5px 12px rgba(190,45,25,.34); }
.beq:active { box-shadow:0 1px 0 var(--eq-sh); }
.bga { background:linear-gradient(170deg,var(--ga-a),var(--ga-b)); color:#fff; box-shadow:0 4px 0 var(--ga-sh),0 5px 12px rgba(0,25,16,.36); }
.bga:active { box-shadow:0 1px 0 var(--ga-sh); }
.btax { background:linear-gradient(170deg,var(--tax-a),var(--tax-b)); color:#fff; font-size:calc(var(--btn)*.26); letter-spacing:.03em; box-shadow:0 3px 0 var(--tax-sh),0 4px 9px rgba(0,30,20,.22); }
.btax:active { box-shadow:0 1px 0 var(--tax-sh); }

.gather-svg {
  width: calc(var(--btn) * 0.58);
  height: calc(var(--btn) * 0.58);
}

/* ===== „Ç≠„Éº„Éë„ÉÉ„Éâ ===== */
.kpad {
  display: grid;
  grid-template-columns: repeat(5, var(--btn));
  gap: var(--gap);
  justify-content: center;
  flex-shrink: 0;
}
</style>
</head>
<body>
<div class="calc" id="calcRoot">
  <p class="app-title">Green Gathering Calculator</p>
  <div class="stage" id="stage">
    <div class="stage-hint" id="stageHint">
      <span class="si">üÉè</span>
      <span class="st">Êï∞Â≠ó„ÇíÂÖ•Âäõ„Åó„Å¶<br>„Éá„Ç£„Çπ„Éó„É¨„Ç§„Çí<strong>‰∏ä„Å´„Çπ„ÉØ„Ç§„Éó</strong>„Åß„Ç´„Éº„ÉâËøΩÂä†</span>
    </div>
    <div class="card-count" id="cardCount"><span id="cardCountNum">0</span> ‰ª∂</div>
    <div class="result-overlay" id="resultOverlay">
      <div class="ro-label">ÈõÜË®àÁµêÊûú</div>
      <div class="ro-formula" id="roFormula"></div>
      <div class="ro-total"   id="roTotal"></div>
      <div class="ro-buttons">
        <button class="ro-use" onclick="useTotal()">‚ñº ÂêàË®àÂÄ§„ÇíÂÖ•Âäõ„Å´‰Ωø„ÅÜ</button>
        <button class="ro-close" onclick="closeResult()">‚úï Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>
  <div class="ctrl">
    <button class="btn bc" onclick="clearAll()">C</button>
    <div class="disp" id="dispBox">
      <div class="d-expr" id="exprLine">&nbsp;</div>
      <div class="d-num"  id="numLine">0</div>
    </div>
    <button class="btn bga" onclick="gatherAll()" title="ÂÖ®„Ç´„Éº„Éâ„ÇíÂêàË®à">
      <svg class="gather-svg" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="20" cy="20" r="16" stroke="rgba(255,255,255,.85)" stroke-width="2.8" fill="none"/>
        <circle cx="20" cy="20" r="3.2" fill="rgba(255,255,255,.95)"/>
        <!-- Â∑¶‰∏ä‚Üí‰∏≠Â§Æ -->
        <line x1="8" y1="8" x2="15.5" y2="15.5" stroke="rgba(255,255,255,.92)" stroke-width="2.5" stroke-linecap="round"/>
        <polyline points="12,15.5 15.5,15.5 15.5,12" stroke="rgba(255,255,255,.92)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        <!-- Âè≥‰∏ä‚Üí‰∏≠Â§Æ -->
        <line x1="32" y1="8" x2="24.5" y2="15.5" stroke="rgba(255,255,255,.92)" stroke-width="2.5" stroke-linecap="round"/>
        <polyline points="28,15.5 24.5,15.5 24.5,12" stroke="rgba(255,255,255,.92)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        <!-- Â∑¶‰∏ã‚Üí‰∏≠Â§Æ -->
        <line x1="8" y1="32" x2="15.5" y2="24.5" stroke="rgba(255,255,255,.92)" stroke-width="2.5" stroke-linecap="round"/>
        <polyline points="12,24.5 15.5,24.5 15.5,28" stroke="rgba(255,255,255,.92)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        <!-- Âè≥‰∏ã‚Üí‰∏≠Â§Æ -->
        <line x1="32" y1="32" x2="24.5" y2="24.5" stroke="rgba(255,255,255,.92)" stroke-width="2.5" stroke-linecap="round"/>
        <polyline points="28,24.5 24.5,24.5 24.5,28" stroke="rgba(255,255,255,.92)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
      </svg>
    </button>
  </div>
  <div class="kpad">
    <button class="btn bn"   onclick="inp('7')">7</button>
    <button class="btn bn"   onclick="inp('8')">8</button>
    <button class="btn bn"   onclick="inp('9')">9</button>
    <button class="btn bop"  onclick="setOp('√∑')">√∑</button>
    <button class="btn bu"   onclick="bspc()">‚å´</button>
    <button class="btn bn"   onclick="inp('4')">4</button>
    <button class="btn bn"   onclick="inp('5')">5</button>
    <button class="btn bn"   onclick="inp('6')">6</button>
    <button class="btn bop"  onclick="setOp('√ó')">√ó</button>
    <button class="btn bu"   onclick="tglSign()">¬±</button>
    <button class="btn bn"   onclick="inp('1')">1</button>
    <button class="btn bn"   onclick="inp('2')">2</button>
    <button class="btn bn"   onclick="inp('3')">3</button>
    <button class="btn bop"  onclick="setOp('‚àí')">‚àí</button>
    <button class="btn bu"   onclick="pct()">%</button>
    <button class="btn bn"   onclick="inp('0')">0</button>
    <button class="btn bn"   onclick="inp('.')">.</button>
    <button class="btn beq"  onclick="calcOnly()">Ôºù</button>
    <button class="btn bop"  onclick="setOp('Ôºã')">Ôºã</button>
    <button class="btn btax" onclick="doTax()">TAX</button>
  </div>
</div>
<script>
/* ===== ÂãïÁöÑ„Éú„Çø„É≥„Çµ„Ç§„Ç∫Ë®àÁÆó ===== */
function recalcLayout() {
  const root = document.getElementById('calcRoot');
  const style = getComputedStyle(root);
  const padX = parseFloat(style.paddingLeft) + parseFloat(style.paddingRight);
  const innerW = root.clientWidth - padX;
  /* --gap „ÅØ clamp() „Å™„ÅÆ„Åß„ÄÅÂÆüÈöõ„ÅÆ kpad „Åã„Çâ gap „ÇíÊ∏¨ÂÆö */
  const kpad = document.querySelector('.kpad');
  const gapPx = parseFloat(getComputedStyle(kpad).columnGap) || parseFloat(getComputedStyle(kpad).gap) || 6;
  const btn = Math.floor((innerW - gapPx * 4) / 5);
  root.style.setProperty('--btn', btn + 'px');
}
/* DOMContentLoadedÂæå„Å´Ë®àÁÆóÔºàkpad„ÅåÁ¢∫ÂÆü„Å´„ÅÇ„ÇãÔºâ */
recalcLayout();
window.addEventListener('resize', recalcLayout);

let cur='0',prev='',op=null,rst=false;
const NL=document.getElementById('numLine'),EL=document.getElementById('exprLine'),DB=document.getElementById('dispBox'),ST=document.getElementById('stage'),SH=document.getElementById('stageHint'),ROV=document.getElementById('resultOverlay'),ROF=document.getElementById('roFormula'),ROT=document.getElementById('roTotal'),CCB=document.getElementById('cardCount'),CCN=document.getElementById('cardCountNum');
let cards=[],cid=0;
function updD(v){const s=String(v);NL.textContent=s;NL.classList.remove('sm','xs');const l=s.replace(/[^0-9.]/g,'').length;if(l>12)NL.classList.add('xs');else if(l>8)NL.classList.add('sm');}
function inp(ch){if(rst){cur='';rst=false;}if(cur==='0'&&ch!='.')cur='';if(ch==='.'&&cur.includes('.'))return;if(cur.replace('-','').length>=13)return;cur+=ch;if(!cur||cur==='-')cur='0';updD(cur);}
function setOp(o){if(op&&!rst)calcOnly(true);prev=cur;op=o;EL.textContent=cur+' '+o;rst=true;}
function calcOnly(chain){if(!op)return false;const p=parseFloat(prev),c=parseFloat(cur);if(isNaN(p)||isNaN(c))return false;let res;switch(op){case 'Ôºã':res=p+c;break;case '‚àí':res=p-c;break;case '√ó':res=p*c;break;case '√∑':res=c===0?null:p/c;break;}if(res===null){EL.textContent='0Èô§ÁÆó„Ç®„É©„Éº';cur='0';op=null;updD('Error');return false;}res=parseFloat(res.toPrecision(12));EL.textContent=prev+' '+op+' '+cur+' Ôºù';prev=String(res);cur=String(res);op=chain?op:null;rst=!chain;updD(res);return res;}
function clearAll(){cur='0';prev='';op=null;rst=false;updD('0');EL.textContent='';closeResult();}
function bspc(){if(rst)return;cur=cur.slice(0,-1)||'0';updD(cur);}
function tglSign(){const n=parseFloat(cur);if(!isNaN(n)&&n!==0){cur=String(n*-1);updD(cur);}}
function pct(){const n=parseFloat(cur);if(!isNaN(n)){cur=String(n/100);updD(cur);}}
function doTax(){const n=parseFloat(cur);if(isNaN(n))return;const r=Math.floor(n*1.1);EL.textContent=cur+'√ó1.1ÔºàÁ®é10%ÔºâÔºù';cur=String(r);rst=true;updD(r);}
function fmt(v){if(Number.isInteger(v))return v.toLocaleString('ja-JP');return parseFloat(v.toPrecision(10)).toLocaleString('ja-JP',{maximumFractionDigits:6});}
function addCard(value,dropX,dropY){cid++;const id=cid,sw=ST.offsetWidth,sh=ST.clientHeight,cw=Math.max(72,fmt(value).length*14+52),ch=44;let x,y;if(dropX!=null&&dropY!=null){x=dropX-cw/2;y=dropY-ch/2;}else if(cards.length===0){x=Math.min(7+Math.random()*22,sw-cw-7);y=7;}else{const l=cards[cards.length-1];x=l.x+8+Math.random()*15-7;y=l.y+48+Math.random()*5-2;}x=Math.max(4,Math.min(x,sw-cw-5));y=Math.max(4,Math.min(y,sh-ch-5));const el=document.createElement('div');el.className='ncard enter';el.innerHTML=`<span class="clbl">#${id}</span><span class="cval">${fmt(value)}</span><button class="cdel" onclick="removeCard(${id})">‚úï</button>`;el.style.left=x+'px';el.style.top=y+'px';ST.appendChild(el);const c={id,value,x,y,el};cards.push(c);el.addEventListener('animationend',()=>el.classList.remove('enter'),{once:true});makeDrag(el,c);updStage();closeResult();}
function removeCard(id){const i=cards.findIndex(c=>c.id===id);if(i<0)return;const{el}=cards[i];el.classList.add('leaving');setTimeout(()=>{el.remove();cards.splice(i,1);updStage();},200);}
function gatherAll(){if(cards.length===0)return;const cnt=cards.length,sum=cards.reduce((a,c)=>a+c.value,0),total=parseFloat(sum.toPrecision(12));let html='';cards.forEach((c,i)=>{if(i>0)html+=`<span class="pl"> Ôºã </span>`;html+=`<strong>${fmt(c.value)}</strong>`;});ROF.innerHTML=html+'<span class="pl"> Ôºù </span>';ROT.textContent=fmt(total);ROV.classList.add('show');cards.forEach(c=>c.el.classList.add('leaving'));setTimeout(()=>{cards.forEach(c=>c.el.remove());cards=[];updStage();},210);cur=String(total);rst=true;op=null;updD(fmt(total));EL.textContent=cnt+'‰ª∂ ÂêàË®à Ôºù';}
function useTotal(){closeResult();rst=true;DB.classList.remove('flash');void DB.offsetWidth;DB.classList.add('flash');}
function closeResult(){ROV.classList.remove('show');}
function updStage(){SH.style.opacity=cards.length===0?'1':'0';CCB.style.display=cards.length===0?'none':'block';if(cards.length)CCN.textContent=cards.length;}
(function(){let dragging=false,ghost=null,startY=0;const THR=26;function getVal(){if(op&&!rst){const r=calcOnly(false);return r===false?null:r;}const n=parseFloat(cur);return isNaN(n)?null:n;}function mkG(val){const g=document.createElement('div');g.className='ghost-card';g.textContent=fmt(val);document.body.appendChild(g);return g;}function mvG(cx,cy){if(!ghost)return;ghost.style.left=(cx-ghost.offsetWidth/2)+'px';ghost.style.top=(cy-ghost.offsetHeight/2)+'px';}function onSt(cx,cy){const r=ST.getBoundingClientRect();return cx>=r.left&&cx<=r.right&&cy>=r.top&&cy<=r.bottom;}function start(cx,cy){const v=getVal();if(v===null)return;dragging=true;startY=cy;DB.classList.add('lift');ghost=mkG(v);mvG(cx,cy);}function move(cx,cy){if(!dragging)return;mvG(cx,cy);ST.classList.toggle('drop-ready',onSt(cx,cy)||cy<startY-THR);}function end(cx,cy){if(!dragging)return;dragging=false;DB.classList.remove('lift');ST.classList.remove('drop-ready');if(ghost){ghost.remove();ghost=null;}if(onSt(cx,cy)||cy<startY-THR){const v=getVal();if(v!==null){const sr=ST.getBoundingClientRect();let lx=cx-sr.left,ly=cy-sr.top;if(!onSt(cx,cy)){lx=Math.max(30,Math.min(sr.width-30,lx));ly=Math.max(20,Math.min(sr.height/2,Math.random()*sr.height*0.6+10));}addCard(v,lx,ly);cur='0';rst=false;op=null;updD('0');EL.textContent='';DB.classList.remove('flash');void DB.offsetWidth;DB.classList.add('flash');}}}DB.addEventListener('mousedown',e=>{e.preventDefault();start(e.clientX,e.clientY);});document.addEventListener('mousemove',e=>move(e.clientX,e.clientY));document.addEventListener('mouseup',e=>end(e.clientX,e.clientY));DB.addEventListener('touchstart',e=>{e.preventDefault();const t=e.touches[0];start(t.clientX,t.clientY);},{passive:false});document.addEventListener('touchmove',e=>{if(!dragging)return;e.preventDefault();const t=e.touches[0];move(t.clientX,t.clientY);},{passive:false});document.addEventListener('touchend',e=>{const t=e.changedTouches[0];end(t.clientX,t.clientY);});})();
function makeDrag(el,card){let sx,sy,drag=false;el.addEventListener('mousedown',e=>{if(e.target.classList.contains('cdel'))return;e.preventDefault();drag=true;el.classList.add('dragging');const r=ST.getBoundingClientRect();sx=e.clientX-r.left-card.x;sy=e.clientY-r.top-card.y;front(el);});document.addEventListener('mousemove',e=>{if(!drag)return;mv(e.clientX,e.clientY,sx,sy,card,el);});document.addEventListener('mouseup',()=>{if(!drag)return;drag=false;el.classList.remove('dragging');});el.addEventListener('touchstart',e=>{if(e.target.classList.contains('cdel'))return;e.preventDefault();drag=true;el.classList.add('dragging');const r=ST.getBoundingClientRect(),t=e.touches[0];sx=t.clientX-r.left-card.x;sy=t.clientY-r.top-card.y;front(el);},{passive:false});document.addEventListener('touchmove',e=>{if(!drag)return;e.preventDefault();const t=e.touches[0];mv(t.clientX,t.clientY,sx,sy,card,el);},{passive:false});document.addEventListener('touchend',()=>{if(!drag)return;drag=false;el.classList.remove('dragging');});}
function mv(cx,cy,sx,sy,card,el){const r=ST.getBoundingClientRect();let nx=cx-r.left-sx,ny=cy-r.top-sy;nx=Math.max(4,Math.min(nx,ST.clientWidth-el.offsetWidth-4));ny=Math.max(4,Math.min(ny,ST.clientHeight-el.offsetHeight-4));card.x=nx;card.y=ny;el.style.left=nx+'px';el.style.top=ny+'px';}
function front(el){document.querySelectorAll('.ncard').forEach(c=>c.style.zIndex=10);el.style.zIndex=80;}
updD('0');
</script>
</body>
</html>
