<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Green Gathering Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

:root {
  --font: 'Nunito', 'Noto Sans JP', sans-serif;

  /* ã‚°ãƒªãƒ¼ãƒ³ãƒ‘ãƒ¬ãƒƒãƒˆ */
  --bg1: #b8e8cc;
  --bg2: #80c89a;
  --body-bg: #f0faf4;
  --stage-bg: #daf2e4;
  --disp-bg:  #d0f0e0;
  --disp-bd:  #a0d8b8;

  /* ãƒœã‚¿ãƒ³ã‚«ãƒ©ãƒ¼ï¼ˆç”»åƒã®é…è‰²ã«åˆã‚ã›ã¤ã¤ç·‘ãƒ™ãƒ¼ã‚¹ï¼‰ */
  --c-num:    #3aae60;   /* æ•°å­— : ãƒŸãƒ³ãƒˆã‚°ãƒªãƒ¼ãƒ³ */
  --c-num-sh: #1e7a3c;
  --c-op-bg:  #f4fdf7;   /* æ¼”ç®—å­ : ã»ã¼ç™½ */
  --c-op-bd:  #b0dcc0;
  --c-op-tx:  #1a6034;
  --c-util:   #7ab896;   /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ : æ·¡ç·‘ã‚°ãƒ¬ãƒ¼ */
  --c-util-sh:#4a8060;
  --c-eq:     #f05040;   /* ï¼ : ã‚³ãƒ¼ãƒ©ãƒ« */
  --c-eq-sh:  #b02818;
  --c-clear:  #d060e0;   /* C : ãƒ‘ãƒ¼ãƒ—ãƒ«ï¼ˆç”»åƒé€šã‚Šï¼‰ */
  --c-clr-sh: #9030a8;
  --c-gather: #88cc44;   /* é›†è¨ˆ : ã‚¤ã‚¨ãƒ­ãƒ¼ã‚°ãƒªãƒ¼ãƒ³ï¼ˆç”»åƒé€šã‚Šï¼‰ */
  --c-gsh:    #5a9020;
  --c-send:   #28b858;   /* â†‘é€ã‚‹ : é®®ã‚„ã‹ã‚°ãƒªãƒ¼ãƒ³ */
  --c-send-sh:#0e7a34;

  /* ã‚«ãƒ¼ãƒ‰ */
  --card-bg:  #52c478;
  --card-sh:  #268c48;
  --card-tx:  #fff;

  /* ãƒ†ã‚­ã‚¹ãƒˆ */
  --td: #0a2e18;
  --tm: #1e5e34;
  --tp: #5aa872;
}

html, body { height: 100%; }
body {
  font-family: var(--font);
  background: linear-gradient(150deg, var(--bg1) 0%, var(--bg2) 100%);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 20px 14px 44px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• é›»å“æœ¬ä½“ â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.calc {
  background: var(--body-bg);
  width: 100%;
  max-width: 390px;
  border-radius: 36px;
  padding: 20px 16px 26px;
  box-shadow:
    0 0 0 1.5px rgba(255,255,255,.85) inset,
    0 24px 64px rgba(12,64,32,.26),
    0 8px 20px rgba(12,64,32,.10);
}

/* ã‚¿ã‚¤ãƒˆãƒ« */
.app-title {
  text-align: center;
  font-size: .6rem;
  font-weight: 900;
  letter-spacing: .28em;
  text-transform: uppercase;
  color: var(--tp);
  margin-bottom: 14px;
  user-select: none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• ã‚«ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stage {
  position: relative;
  width: 100%;
  min-height: 260px;
  background: linear-gradient(140deg, #ceeeda 0%, #b8e8c8 100%);
  border-radius: 22px;
  border: 2px dashed rgba(40,150,80,.22);
  margin-bottom: 10px;
  overflow: hidden;
  transition: min-height .3s ease;
}
.stage-hint {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%,-50%);
  text-align: center; pointer-events: none;
  transition: opacity .3s; user-select: none;
}
.stage-hint .si { font-size: 1.7rem; opacity: .35; display: block; margin-bottom: 5px; }
.stage-hint .st { font-size: .62rem; font-weight: 700; color: var(--tp); letter-spacing: .07em; line-height: 1.7; }

/* â”€â”€ æ•°å­—ã‚«ãƒ¼ãƒ‰ â”€â”€ */
.ncard {
  position: absolute;
  background: linear-gradient(145deg, #68d48e, #38a85a);
  border-radius: 16px;
  padding: 9px 14px 9px 10px;
  min-width: 78px;
  box-shadow: 0 4px 0 var(--card-sh), 0 6px 16px rgba(20,90,48,.3);
  cursor: grab; user-select: none; touch-action: none;
  display: flex; align-items: center; gap: 5px;
  z-index: 10;
  transition: box-shadow .1s, transform .1s;
}
.ncard.dragging {
  cursor: grabbing;
  box-shadow: 0 8px 0 var(--card-sh), 0 14px 32px rgba(20,90,48,.42);
  transform: scale(1.07) rotate(-1.5deg);
  z-index: 100;
}
.ncard.enter { animation: cIn .36s cubic-bezier(.34,1.56,.64,1); }
@keyframes cIn { from { transform: scale(.4) translateY(24px); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.ncard.leaving { animation: cOut .2s ease-in forwards; }
@keyframes cOut { to { transform: scale(.5); opacity: 0; } }

.clbl { font-size: .5rem; font-weight: 900; color: rgba(255,255,255,.7); letter-spacing: .08em; white-space: nowrap; }
.cval { font-size: 1.25rem; font-weight: 900; color: #fff; letter-spacing: -.02em; white-space: nowrap; flex: 1; text-align: right; }
.cdel {
  width: 18px; height: 18px;
  background: rgba(255,255,255,.25); border: none; border-radius: 50%;
  color: rgba(255,255,255,.88); font-size: .6rem; font-weight: 900;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; transition: background .15s;
}
.cdel:hover { background: rgba(255,60,40,.6); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• åˆè¨ˆãƒãƒ¼ â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.total-bar {
  background: linear-gradient(90deg, #b4eccc, #9ee4b8);
  border: 1.5px solid rgba(40,150,80,.2);
  border-radius: 14px;
  padding: 7px 15px;
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 10px;
}
.t-lbl { font-size: .58rem; font-weight: 800; letter-spacing: .14em; text-transform: uppercase; color: var(--tm); opacity: .8; }
.t-val { font-size: 1rem; font-weight: 900; color: var(--td); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• é›†è¨ˆçµæœãƒ‘ãƒãƒ« â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.result-panel {
  display: none;
  background: linear-gradient(135deg, #ccf4dc, #b8ecc8);
  border: 2px solid rgba(28,150,72,.28);
  border-radius: 18px;
  padding: 14px 16px 12px;
  margin-bottom: 10px;
  animation: pIn .38s cubic-bezier(.34,1.3,.64,1);
}
@keyframes pIn { from { transform: scale(.92) translateY(-8px); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.result-panel.show { display: block; }
.rp-hd { font-size: .58rem; font-weight: 900; letter-spacing: .18em; text-transform: uppercase; color: var(--tm); opacity: .72; margin-bottom: 7px; }
.rp-formula { font-size: .8rem; font-weight: 700; color: var(--tm); line-height: 1.75; word-break: break-all; margin-bottom: 6px; }
.rp-formula .plus { color: var(--c-num); font-weight: 900; margin: 0 2px; }
.rp-formula .eq   { color: var(--td);   font-weight: 900; margin: 0 3px; }
.rp-total { font-size: 1.65rem; font-weight: 900; color: var(--td); text-align: right; border-top: 1.5px solid rgba(28,150,72,.18); padding-top: 6px; }
.rp-close {
  display: block; width: 100%; margin-top: 8px;
  background: rgba(28,150,72,.14); border: none; border-radius: 10px;
  padding: 6px; font-family: var(--font); font-size: .68rem; font-weight: 800;
  color: var(--tm); cursor: pointer; transition: background .15s;
}
.rp-close:hover { background: rgba(28,150,72,.26); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* ç”»åƒé€šã‚Šï¼šCä¸¸ãƒœã‚¿ãƒ³ | ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤æ¨ªé•· | é›†è¨ˆä¸¸ãƒœã‚¿ãƒ³ */
.ctrl {
  display: grid;
  grid-template-columns: 68px 1fr 68px;
  gap: 10px;
  align-items: center;
  margin-bottom: 14px;
}

/* ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ */
.disp {
  background: var(--disp-bg);
  border: 2px solid var(--disp-bd);
  border-radius: 20px;
  height: 68px;
  padding: 6px 16px;
  display: flex; flex-direction: column;
  justify-content: center; align-items: flex-end;
  overflow: hidden;
  cursor: grab;
  user-select: none;
  touch-action: none;
  transition: transform .12s ease, box-shadow .12s ease, border-color .15s;
  position: relative;
}
.disp:hover {
  border-color: #70c890;
  box-shadow: 0 0 0 3px rgba(40,180,90,.15);
}
.disp.lift {
  cursor: grabbing;
  transform: scale(1.04) translateY(-4px);
  box-shadow: 0 10px 28px rgba(20,90,48,.28);
  border-color: #38b868;
  z-index: 200;
}
/* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚´ãƒ¼ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ä¸Šã‚’æ¼‚ã†ï¼‰ */
.ghost-card {
  position: fixed;
  pointer-events: none;
  z-index: 9999;
  background: linear-gradient(145deg, #68d48e, #38a85a);
  border-radius: 16px;
  padding: 9px 18px;
  font-family: var(--font);
  font-size: 1.25rem;
  font-weight: 900;
  color: #fff;
  box-shadow: 0 8px 24px rgba(20,90,48,.45);
  transform: scale(1.05) rotate(-2deg);
  opacity: .92;
  white-space: nowrap;
  transition: opacity .15s;
}
/* ã‚¹ãƒ†ãƒ¼ã‚¸ãŒãƒ‰ãƒ­ãƒƒãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã—ã¦å…‰ã‚‹ */
.stage.drop-ready {
  border-color: rgba(40,180,90,.6);
  background: linear-gradient(140deg, #c0eed0 0%, #a8e4be 100%);
  box-shadow: inset 0 0 20px rgba(40,180,90,.15);
}
.d-expr { font-size: .62rem; font-weight: 600; color: var(--tp); min-height: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
.d-num  {
  font-family: var(--font); font-size: 2rem; font-weight: 900;
  color: var(--td); letter-spacing: -.03em;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;
  line-height: 1.05; transition: font-size .1s;
}
.d-num.sm { font-size: 1.5rem; }
.d-num.xs { font-size: 1.1rem; }
@keyframes dfl { 0%,100%{background:var(--disp-bg)} 40%{background:#88e8aa} }
.disp.flash { animation: dfl .42s ease; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• ãƒœã‚¿ãƒ³ â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* ç”»åƒã«åˆã‚ã›ãŸã‚µã‚¤ã‚ºæ„Ÿï¼šã‚„ã‚„å¤§ãã‚ã®ä¸¸ */
.btn {
  border: none;
  border-radius: 50%;
  width: 68px; height: 68px;
  font-family: var(--font);
  font-size: 1.15rem; font-weight: 800;
  cursor: pointer;
  display: flex; justify-content: center; align-items: center;
  margin: 0 auto;
  user-select: none;
  transition: transform .09s ease, box-shadow .09s ease;
}
.btn:active { transform: scale(.88) translateY(2px); }

/* æ•°å­—ï¼šç·‘ */
.bn {
  background: linear-gradient(170deg, #50cc78, #28a850);
  color: #fff; font-size: 1.6rem;
  box-shadow: 0 5px 0 var(--c-num-sh), 0 7px 16px rgba(40,168,80,.34);
}
.bn:active { box-shadow: 0 2px 0 var(--c-num-sh); }

/* æ¼”ç®—å­ï¼šç™½ */
.bop {
  background: var(--c-op-bg); color: var(--c-op-tx);
  font-size: 1.4rem;
  border: 2px solid var(--c-op-bd);
  box-shadow: 0 4px 0 #b8d8c4, 0 5px 10px rgba(0,0,0,.06);
}
.bop:active { box-shadow: 0 1px 0 #b8d8c4; }

/* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šæ·¡ç·‘ã‚°ãƒ¬ãƒ¼ */
.bu {
  background: linear-gradient(170deg, #90c8a8, #60a080);
  color: #fff; font-size: 1rem;
  box-shadow: 0 4px 0 var(--c-util-sh), 0 5px 10px rgba(80,130,96,.28);
}
.bu:active { box-shadow: 0 1px 0 var(--c-util-sh); }

/* Cï¼šãƒ‘ãƒ¼ãƒ—ãƒ«ï¼ˆç”»åƒé€šã‚Šï¼‰ */
.bc {
  background: linear-gradient(170deg, #cc60e0, #a030c0);
  color: #fff; font-size: 1.2rem;
  box-shadow: 0 5px 0 var(--c-clr-sh), 0 7px 16px rgba(160,48,192,.36);
}
.bc:active { box-shadow: 0 2px 0 var(--c-clr-sh); }

/* ï¼ï¼šã‚³ãƒ¼ãƒ©ãƒ« */
.beq {
  background: linear-gradient(170deg, #f87060, #e03828);
  color: #fff; font-size: 1.5rem;
  box-shadow: 0 5px 0 var(--c-eq-sh), 0 7px 16px rgba(224,56,40,.38);
}
.beq:active { box-shadow: 0 2px 0 var(--c-eq-sh); }

/* â†‘é€ã‚‹ï¼šé®®ã‚„ã‹ã‚°ãƒªãƒ¼ãƒ³ï¼ˆæ•°å­—ã¨åŒè‰²ç³»ï¼‰ */
.bsend {
  background: linear-gradient(170deg, #38d878, #18b050);
  color: #fff;
  box-shadow: 0 5px 0 var(--c-send-sh), 0 7px 18px rgba(24,176,80,.42);
}
.bsend:active { box-shadow: 0 2px 0 var(--c-send-sh); }

/* é›†è¨ˆï¼šã‚¤ã‚¨ãƒ­ãƒ¼ã‚°ãƒªãƒ¼ãƒ³ï¼ˆç”»åƒé€šã‚Šï¼‰ */
.bga {
  background: linear-gradient(170deg, #a0dd44, #78b820);
  color: #fff;
  box-shadow: 0 5px 0 var(--c-gsh), 0 7px 18px rgba(120,184,32,.4);
}
.bga:active { box-shadow: 0 2px 0 var(--c-gsh); }

/* TAX */
.btax {
  background: linear-gradient(170deg, #80bc50, #58981a);
  color: #fff; font-size: .76rem; letter-spacing: .04em;
  box-shadow: 0 4px 0 #3a6810, 0 5px 12px rgba(88,152,26,.3);
}
.btax:active { box-shadow: 0 1px 0 #3a6810; }

/* â”€â”€ é›†è¨ˆãƒœã‚¿ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆç”»åƒã®é›†ã¾ã‚‹çŸ¢å°ï¼‰ â”€â”€ */
.gico {
  width: 28px; height: 28px;
  position: relative;
  display: flex; justify-content: center; align-items: center;
}
/* å››éš…ã®å†…å‘ãçŸ¢å°ã‚’ç–‘ä¼¼è¦ç´ ï¼‹è¿½åŠ divã§è¡¨ç¾ */
.gico .g-tl, .gico .g-tr,
.gico .g-bl, .gico .g-br {
  position: absolute;
  width: 10px; height: 10px;
  border: 2.5px solid rgba(255,255,255,.95);
}
.gico .g-tl { top:    1px; left:  1px; border-color: rgba(255,255,255,.95) transparent transparent rgba(255,255,255,.95); }
.gico .g-tr { top:    1px; right: 1px; border-color: rgba(255,255,255,.95) rgba(255,255,255,.95) transparent transparent; }
.gico .g-bl { bottom: 1px; left:  1px; border-color: transparent transparent rgba(255,255,255,.95) rgba(255,255,255,.95); }
.gico .g-br { bottom: 1px; right: 1px; border-color: transparent rgba(255,255,255,.95) rgba(255,255,255,.95) transparent; }
.gico .g-dot { width: 5px; height: 5px; background: rgba(255,255,255,.95); border-radius: 50%; }

/* â†‘ é€ã‚‹ã‚¢ã‚¤ã‚³ãƒ³ */
.send-ico {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
}
.send-tri {
  width: 0; height: 0;
  border-left: 9px solid transparent;
  border-right: 9px solid transparent;
  border-bottom: 11px solid #fff;
}
.send-bar { width: 4px; height: 7px; background: #fff; border-radius: 2px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ï¼ˆç”»åƒé€šã‚Šã‚·ãƒ³ãƒ—ãƒ«4è¡Œï¼‰ â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.kpad {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 12px;
}

/* hintå‰Šé™¤ */

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes tpop { 0%{transform:scale(1)} 45%{transform:scale(1.13)} 100%{transform:scale(1)} }
.t-val.pop { animation: tpop .25s ease-out; }

@media (max-width: 370px) {
  .btn  { width: 58px; height: 58px; }
  .bn   { font-size: 1.4rem; }
  .kpad { gap: 9px; }
  .ctrl { grid-template-columns: 58px 1fr 58px; gap: 8px; }
  .disp { height: 60px; }
}
</style>
</head>
<body>
<div class="calc">

  <p class="app-title">Green Gathering Calculator</p>

  <!-- â”€â”€ ã‚«ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ â”€â”€ -->
  <div class="stage" id="stage">
    <div class="stage-hint" id="stageHint">
      <span class="si">ğŸƒ</span>
      <span class="st">æ•°å­—ã‚’å…¥åŠ›ã—ã¦<br>ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚’<strong>ä¸Šã«ãƒ‰ãƒ©ãƒƒã‚°</strong><br>ã§ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ </span>
    </div>
  </div>

  <!-- â”€â”€ åˆè¨ˆãƒãƒ¼ â”€â”€ -->
  <div class="total-bar">
    <span class="t-lbl">ã‚«ãƒ¼ãƒ‰åˆè¨ˆ</span>
    <span class="t-val" id="totalVal">0</span>
  </div>

  <!-- â”€â”€ é›†è¨ˆçµæœãƒ‘ãƒãƒ« â”€â”€ -->
  <div class="result-panel" id="resultPanel">
    <div class="rp-hd">é›†è¨ˆçµæœ</div>
    <div class="rp-formula" id="rpFormula"></div>
    <div class="rp-total"   id="rpTotal"></div>
    <button class="rp-close" onclick="closeResult()">âœ• é–‰ã˜ã‚‹</button>
  </div>

  <!-- â”€â”€ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆC | ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ | é›†è¨ˆï¼‰â”€â”€ -->
  <div class="ctrl">
    <button class="btn bc"  onclick="clearAll()">C</button>
    <div class="disp" id="dispBox">
      <div class="d-expr" id="exprLine">&nbsp;</div>
      <div class="d-num"  id="numLine">0</div>
    </div>
    <button class="btn bga" onclick="gatherAll()">
      <div class="gico">
        <div class="g-tl"></div><div class="g-tr"></div>
        <div class="g-bl"></div><div class="g-br"></div>
        <div class="g-dot"></div>
      </div>
    </button>
  </div>

  <!-- â”€â”€ ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ï¼ˆç”»åƒé€šã‚Š 4è¡ŒÃ—5åˆ—ï¼‰ â”€â”€ -->
  <div class="kpad">

    <!-- è¡Œ1: 7 8 9 Ã· âŒ« -->
    <button class="btn bn"   onclick="inp('7')">7</button>
    <button class="btn bn"   onclick="inp('8')">8</button>
    <button class="btn bn"   onclick="inp('9')">9</button>
    <button class="btn bop"  onclick="setOp('Ã·')">Ã·</button>
    <button class="btn bu"   onclick="bspc()">âŒ«</button>

    <!-- è¡Œ2: 4 5 6 Ã— Â± -->
    <button class="btn bn"   onclick="inp('4')">4</button>
    <button class="btn bn"   onclick="inp('5')">5</button>
    <button class="btn bn"   onclick="inp('6')">6</button>
    <button class="btn bop"  onclick="setOp('Ã—')">Ã—</button>
    <button class="btn bu"   onclick="tglSign()">Â±</button>

    <!-- è¡Œ3: 1 2 3 âˆ’ % -->
    <button class="btn bn"   onclick="inp('1')">1</button>
    <button class="btn bn"   onclick="inp('2')">2</button>
    <button class="btn bn"   onclick="inp('3')">3</button>
    <button class="btn bop"  onclick="setOp('âˆ’')">âˆ’</button>
    <button class="btn bu"   onclick="pct()">%</button>

    <!-- è¡Œ4: 0 . ï¼ ï¼‹ TAX -->
    <button class="btn bn"   onclick="inp('0')">0</button>
    <button class="btn bn"   onclick="inp('.')">.</button>
    <button class="btn beq"  onclick="calcAndSend()">ï¼</button>
    <button class="btn bop"  onclick="setOp('ï¼‹')">ï¼‹</button>
    <button class="btn btax" onclick="doTax()">TAX</button>

  </div>

  <!-- ãƒ’ãƒ³ãƒˆãªã— -->

</div><!-- /.calc -->

<script>
/* â•â• é›»å“ã‚¹ãƒ†ãƒ¼ãƒˆ â•â• */
let cur='0', prev='', op=null, rst=false;

const NL = document.getElementById('numLine');
const EL = document.getElementById('exprLine');
const DB = document.getElementById('dispBox');
const TV = document.getElementById('totalVal');
const ST = document.getElementById('stage');
const SH = document.getElementById('stageHint');
const RP = document.getElementById('resultPanel');
const RF = document.getElementById('rpFormula');
const RT = document.getElementById('rpTotal');

let cards=[], cid=0;

/* â”€â”€ ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤æ›´æ–° â”€â”€ */
function updD(v){
  const s=String(v);
  NL.textContent=s;
  NL.classList.remove('sm','xs');
  const l=s.replace(/[^0-9.]/g,'').length;
  if(l>12)NL.classList.add('xs');
  else if(l>8)NL.classList.add('sm');
}

/* â”€â”€ æ•°å­—å…¥åŠ› â”€â”€ */
function inp(ch){
  if(rst){cur='';rst=false;}
  if(cur==='0'&&ch!='.')cur='';
  if(ch==='.'&&cur.includes('.'))return;
  if(cur.replace('-','').length>=13)return;
  cur+=ch; if(!cur||cur==='-')cur='0';
  updD(cur);
}

/* â”€â”€ æ¼”ç®—å­ã‚»ãƒƒãƒˆ â”€â”€ */
function setOp(o){
  if(op&&!rst)calcOnly(true);
  prev=cur; op=o;
  EL.textContent=cur+' '+o;
  rst=true;
}

/* â”€â”€ è¨ˆç®—ã®ã¿ï¼ˆãƒã‚§ãƒ¼ãƒ³ç”¨ï¼‰â”€â”€ */
function calcOnly(chain){
  if(!op)return false;
  const p=parseFloat(prev), c=parseFloat(cur);
  if(isNaN(p)||isNaN(c))return false;
  let res;
  switch(op){
    case 'ï¼‹':res=p+c;break;
    case 'âˆ’':res=p-c;break;
    case 'Ã—':res=p*c;break;
    case 'Ã·':res=c===0?null:p/c;break;
  }
  if(res===null){EL.textContent='0é™¤ç®—ã‚¨ãƒ©ãƒ¼';cur='0';op=null;updD('Error');return false;}
  res=parseFloat(res.toPrecision(12));
  EL.textContent=prev+' '+op+' '+cur+' ï¼';
  prev=String(res); cur=String(res);
  op=chain?op:null; rst=!chain;
  updD(res);
  return res;
}

/* â”€â”€ ï¼ è¨ˆç®—ç¢ºå®šã®ã¿ï¼ˆã‚«ãƒ¼ãƒ‰ã«ã¯è¿½åŠ ã—ãªã„ï¼‰â”€â”€ */
function calcAndSend(){
  if(op&&!rst){
    calcOnly(false);
  }
  /* ã‚«ãƒ¼ãƒ‰ã«ã¯è¿½åŠ ã—ãªã„ã€‚ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚’ä¸Šã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é€ã‚‹ */
}

/* â”€â”€ ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã‚«ãƒ¼ãƒ‰ã«é€ã‚‹ â”€â”€ */
(function initDispDrag(){
  const disp = DB;
  let dragging = false;
  let ghost = null;
  let startY = 0, curClientX = 0, curClientY = 0;
  const THRESHOLD = 40; // pxä¸Šã«å‹•ã‹ã—ãŸã‚‰ãƒ‰ãƒ­ãƒƒãƒ—åˆ¤å®š

  function getDispValue(){
    const n = parseFloat(cur);
    return isNaN(n) ? null : (op && !rst ? null : n);
  }

  function createGhost(val){
    const g = document.createElement('div');
    g.className = 'ghost-card';
    g.textContent = fmt(val);
    document.body.appendChild(g);
    return g;
  }

  function moveGhost(cx, cy){
    if(!ghost) return;
    ghost.style.left = (cx - ghost.offsetWidth/2) + 'px';
    ghost.style.top  = (cy - ghost.offsetHeight/2) + 'px';
  }

  function isOverStage(cx, cy){
    const r = ST.getBoundingClientRect();
    return cx >= r.left && cx <= r.right && cy >= r.top && cy <= r.bottom;
  }

  function startDrag(cx, cy){
    const val = getDispValue();
    if(val === null) return;
    dragging = true;
    startY = cy;
    curClientX = cx; curClientY = cy;
    disp.classList.add('lift');
    ghost = createGhost(val);
    moveGhost(cx, cy);
  }

  function moveDrag(cx, cy){
    if(!dragging) return;
    curClientX = cx; curClientY = cy;
    moveGhost(cx, cy);
    if(isOverStage(cx, cy) || cy < startY - THRESHOLD){
      ST.classList.add('drop-ready');
    } else {
      ST.classList.remove('drop-ready');
    }
  }

  function endDrag(cx, cy){
    if(!dragging) return;
    dragging = false;
    disp.classList.remove('lift');
    ST.classList.remove('drop-ready');
    if(ghost){ ghost.remove(); ghost = null; }

    /* ã‚¹ãƒ†ãƒ¼ã‚¸ã®ä¸Šã«é‡ãªã£ã¦ã„ã‚‹ã‹ã€ä¸Šæ–¹å‘ã«ååˆ†å‹•ã„ãŸã‹ */
    if(isOverStage(cx, cy) || cy < startY - THRESHOLD){
      const val = getDispValue();
      if(val !== null){
        addCard(val);
        /* ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ãƒªã‚»ãƒƒãƒˆ */
        cur='0'; rst=false; op=null;
        updD('0'); EL.textContent='';
        DB.classList.remove('flash'); void DB.offsetWidth; DB.classList.add('flash');
      }
    }
  }

  /* ãƒã‚¦ã‚¹ */
  disp.addEventListener('mousedown', e=>{
    e.preventDefault();
    startDrag(e.clientX, e.clientY);
  });
  document.addEventListener('mousemove', e=>{ moveDrag(e.clientX, e.clientY); });
  document.addEventListener('mouseup',   e=>{ endDrag(e.clientX, e.clientY); });

  /* ã‚¿ãƒƒãƒ */
  disp.addEventListener('touchstart', e=>{
    e.preventDefault();
    const t = e.touches[0];
    startDrag(t.clientX, t.clientY);
  }, {passive:false});
  document.addEventListener('touchmove', e=>{
    if(!dragging) return;
    e.preventDefault();
    const t = e.touches[0];
    moveDrag(t.clientX, t.clientY);
  }, {passive:false});
  document.addEventListener('touchend', e=>{
    const t = e.changedTouches[0];
    endDrag(t.clientX, t.clientY);
  });
})();

/* â”€â”€ C ã‚¯ãƒªã‚¢ â”€â”€ */
function clearAll(){cur='0';prev='';op=null;rst=false;updD('0');EL.textContent='';}

/* â”€â”€ âŒ« ãƒãƒƒã‚¯ã‚¹ãƒšãƒ¼ã‚¹ â”€â”€ */
function bspc(){if(rst)return;cur=cur.slice(0,-1)||'0';updD(cur);}

/* â”€â”€ Â± ç¬¦å· â”€â”€ */
function tglSign(){const n=parseFloat(cur);if(!isNaN(n)&&n!==0){cur=String(n*-1);updD(cur);}}

/* â”€â”€ % â”€â”€ */
function pct(){const n=parseFloat(cur);if(!isNaN(n)){cur=String(n/100);updD(cur);}}

/* â”€â”€ TAX (10%) â”€â”€ */
function doTax(){
  const n=parseFloat(cur);if(isNaN(n))return;
  const r=Math.floor(n*1.1);
  EL.textContent=cur+'Ã—1.1ï¼ˆç¨10%ï¼‰ï¼';
  cur=String(r); rst=true; updD(r);
}

/* â•â• ã‚«ãƒ¼ãƒ‰è¿½åŠ  â•â• */
function addCard(value){
  cid++;
  const id=cid;
  const sw=ST.offsetWidth;
  const cw=Math.max(78, fmt(value).length*15+56);

  /* è¿½åŠ ä½ç½®ï¼šç©ã¿é‡ãªã‚‹ã‚ˆã†ã«å°‘ã—ãšã¤ãšã‚‰ã™ */
  let x,y;
  if(cards.length===0){
    x=Math.min(10+Math.random()*40, sw-cw-10);
    y=10;
  } else {
    const last=cards[cards.length-1];
    x=last.x+12+Math.random()*24-12;
    y=last.y+52+Math.random()*8-4;
    x=Math.max(4, Math.min(x, sw-cw-8));
    const maxY=ST.scrollHeight-52-8;
    y=Math.max(4, Math.min(y, maxY));
  }

  const el=document.createElement('div');
  el.className='ncard enter';
  el.innerHTML=
    `<span class="clbl">#${id}</span>`+
    `<span class="cval">${fmt(value)}</span>`+
    `<button class="cdel" onclick="removeCard(${id})">âœ•</button>`;
  el.style.left=x+'px';
  el.style.top =y+'px';
  ST.appendChild(el);

  const c={id,value,x,y,el};
  cards.push(c);
  el.addEventListener('animationend',()=>el.classList.remove('enter'),{once:true});
  makeDrag(el,c);
  updStage(); updTotal(); closeResult();
}

/* â•â• ã‚«ãƒ¼ãƒ‰å‰Šé™¤ â•â• */
function removeCard(id){
  const i=cards.findIndex(c=>c.id===id);
  if(i<0)return;
  const {el}=cards[i];
  el.classList.add('leaving');
  setTimeout(()=>{el.remove();cards.splice(i,1);updStage();updTotal();},220);
}

/* â•â• å…¨ã‚«ãƒ¼ãƒ‰é›†è¨ˆ â•â• */
function gatherAll(){
  if(cards.length===0)return;
  const sum=cards.reduce((a,c)=>a+c.value,0);
  const total=parseFloat(sum.toPrecision(12));

  /* è©³ç´°ãƒ•ã‚©ãƒ¼ãƒŸãƒ¥ãƒ© */
  let html='';
  cards.forEach((c,i)=>{
    if(i>0)html+=`<span class="plus"> ï¼‹ </span>`;
    html+=`<strong>${fmt(c.value)}</strong>`;
  });
  html+=`<span class="eq"> ï¼ </span>`;
  RF.innerHTML=html;
  RT.textContent=fmt(total);
  RP.classList.add('show');

  /* å…¨ã‚«ãƒ¼ãƒ‰ã‚’ã‚¢ãƒ‹ãƒ¡ã§æ¶ˆã™ */
  cards.forEach(c=>c.el.classList.add('leaving'));
  setTimeout(()=>{
    cards.forEach(c=>c.el.remove());
    cards=[];
    updStage(); updTotal();
  },230);

  /* ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã«ã‚‚åæ˜  */
  cur=String(total); rst=true; op=null;
  updD(fmt(total));
  EL.textContent=`${cards.length>0?cards.length+'ä»¶':''} åˆè¨ˆ ï¼`;
}

function closeResult(){ RP.classList.remove('show'); }

/* â•â• ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ»åˆè¨ˆ æ›´æ–° â•â• */
function updStage(){
  SH.style.opacity=cards.length===0?'1':'0';
  if(cards.length===0){ST.style.minHeight='260px';return;}
  const maxB=Math.max(...cards.map(c=>(c.el.offsetHeight||50)+c.y+14));
  ST.style.minHeight=Math.max(200,maxB)+'px';
}
function updTotal(){
  const s=cards.reduce((a,c)=>a+c.value,0);
  const r=parseFloat(s.toPrecision(12));
  TV.textContent=fmt(r);
  TV.classList.remove('pop'); void TV.offsetWidth; TV.classList.add('pop');
}

/* â•â• æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ â•â• */
function fmt(v){
  if(Number.isInteger(v))return v.toLocaleString('ja-JP');
  return parseFloat(v.toPrecision(10)).toLocaleString('ja-JP',{maximumFractionDigits:6});
}

/* â•â• ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆãƒã‚¦ã‚¹ï¼‹ã‚¿ãƒƒãƒï¼‰ â•â• */
function makeDrag(el,card){
  let sx,sy,drag=false;

  el.addEventListener('mousedown',e=>{
    if(e.target.classList.contains('cdel'))return;
    e.preventDefault(); drag=true;
    el.classList.add('dragging');
    const r=ST.getBoundingClientRect();
    sx=e.clientX-r.left-card.x;
    sy=e.clientY-r.top -card.y;
    front(el);
  });
  document.addEventListener('mousemove',e=>{if(!drag)return;mv(e.clientX,e.clientY,sx,sy,card,el);});
  document.addEventListener('mouseup',()=>{if(!drag)return;drag=false;el.classList.remove('dragging');updStage();});

  el.addEventListener('touchstart',e=>{
    if(e.target.classList.contains('cdel'))return;
    e.preventDefault(); drag=true;
    el.classList.add('dragging');
    const r=ST.getBoundingClientRect(),t=e.touches[0];
    sx=t.clientX-r.left-card.x;
    sy=t.clientY-r.top -card.y;
    front(el);
  },{passive:false});
  document.addEventListener('touchmove',e=>{
    if(!drag)return;e.preventDefault();
    const t=e.touches[0];mv(t.clientX,t.clientY,sx,sy,card,el);
  },{passive:false});
  document.addEventListener('touchend',()=>{if(!drag)return;drag=false;el.classList.remove('dragging');updStage();});
}

function mv(cx,cy,sx,sy,card,el){
  const r=ST.getBoundingClientRect();
  let nx=cx-r.left-sx, ny=cy-r.top-sy;
  nx=Math.max(4,Math.min(nx, ST.offsetWidth -el.offsetWidth -4));
  ny=Math.max(4,Math.min(ny, ST.scrollHeight-el.offsetHeight-4));
  card.x=nx; card.y=ny;
  el.style.left=nx+'px'; el.style.top=ny+'px';
}
function front(el){
  document.querySelectorAll('.ncard').forEach(c=>c.style.zIndex=10);
  el.style.zIndex=100;
}

/* åˆæœŸåŒ– */
updD('0');
</script>
</body>
</html>
