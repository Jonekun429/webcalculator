<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Green Gathering Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after {
  box-sizing: border-box; margin: 0; padding: 0;
  -webkit-tap-highlight-color: transparent;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ã‚«ãƒ©ãƒ¼ã‚·ã‚¹ãƒ†ãƒ 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --font:      'Nunito','Noto Sans JP',sans-serif;
  --brand:     #005D4D;  --brand-mid: #007A66;  --brand-deep: #002820;
  --bg-s:      #9CCEC6;  --bg-e:      #6AAFAA;
  --body-bg:   #F0FBF9;
  --stage-a:   #D4EEE9;  --stage-b:   #BFE4DC;
  --disp-bg:   #C4EAE4;  --disp-bd:   #84C8C0;
  --card-a:    #00B896;  --card-b:    #007A66;  --card-sh: #004D40;
  --bn-a:      #00A070;  --bn-b:      #006850;  --bn-sh:   #003828;
  --op-bg:     #FFFFFF;  --op-bd:     #9CCEC6;  --op-tx:   #005D4D;
  --ut-a:      #68B4AC;  --ut-b:      #46948C;  --ut-sh:   #2A6860;
  --eq-a:      #F04838;  --eq-sh:     #9E2010;
  --cl-a:      #8858D0;  --cl-sh:     #4C2898;
  --ga-a:      #009C6A;  --ga-b:      #006C48;  --ga-sh:   #003828;
  --tax-a:     #4CA488;  --tax-b:     #347C68;  --tax-sh:  #1C5040;
  --td:        #001A12;  --tm:        #003428;  --tp:      #469080;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ãƒšãƒ¼ã‚¸å…¨ä½“
   ã‚¹ãƒãƒ›: å…¨ç”»é¢ã´ã£ãŸã‚Š
   PC    : ä¸­å¤®ã«é›»å“
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
html {
  height: 100%;
  /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã§å¹…ãŒå¤‰ã‚ã‚‰ãªã„ã‚ˆã†ã« */
  overflow-y: scroll;
  scrollbar-width: none;
}
html::-webkit-scrollbar { display: none; }

body {
  font-family: var(--font);
  min-height: 100dvh;
  background: linear-gradient(150deg, var(--bg-s), var(--bg-e));
  background-attachment: fixed;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: max(16px, 2vh) max(12px, 2vw);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   é›»å“ã‚«ãƒ¼ãƒ‰
   å¹…: ã‚¹ãƒãƒ›ã¯ä½™ç™½è¾¼ã¿ã§100%, PCã¯480pxä¸Šé™
   ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰: å†…åŒ…ã™ã‚‹ .kpad ãŒå®Ÿéš›ã®å¹…ã‚’æ±ºã‚ã‚‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.calc {
  --inner-w: min(
    calc(100vw - 24px),   /* ã‚¹ãƒãƒ›: å·¦å³12pxä½™ç™½ */
    480px                  /* PCä¸Šé™ */
  );
  /* ãƒœã‚¿ãƒ³ç›´å¾„ = (å†…å¹… - gapÃ—4) / 5 */
  --gap:  clamp(7px, 1.8vw, 11px);
  --btn:  calc((var(--inner-w) - 32px - var(--gap) * 4) / 5);
  /* ã‚¹ãƒ†ãƒ¼ã‚¸é«˜ã• = åˆ©ç”¨å¯èƒ½ãªç¸¦ã®ä½™ç™½ã‹ã‚‰å‹•çš„ã« */
  --stage-h: clamp(160px, 28dvh, 280px);

  background: var(--body-bg);
  width: var(--inner-w);
  border-radius: clamp(20px, 4vw, 34px);
  padding: clamp(14px, 3vh, 20px) clamp(14px, 2vw, 18px) clamp(16px, 3vh, 22px);
  display: flex;
  flex-direction: column;
  gap: clamp(6px, 1.2vh, 10px);
  box-shadow:
    0 0 0 1.5px rgba(255,255,255,.88) inset,
    0 20px 60px rgba(0,20,16,.28),
    0 6px 18px rgba(0,20,16,.12);
  overflow: hidden;
}

/* ã‚¿ã‚¤ãƒˆãƒ« */
.app-title {
  text-align: center;
  font-size: clamp(.5rem, 1.2vw, .62rem);
  font-weight: 900; letter-spacing: .26em; text-transform: uppercase;
  color: var(--tp); user-select: none; flex-shrink: 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ã‚«ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stage {
  position: relative;
  width: 100%;
  height: var(--stage-h);
  flex-shrink: 0;
  background: linear-gradient(138deg, var(--stage-a), var(--stage-b));
  border-radius: clamp(12px, 2.5vw, 20px);
  border: 2px dashed rgba(0,93,77,.2);
  overflow: hidden;
}

/* ãƒ’ãƒ³ãƒˆ */
.stage-hint {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 5px;
  pointer-events: none; transition: opacity .28s; user-select: none;
}
.stage-hint .si {
  font-size: clamp(1rem, 4vw, 1.5rem); opacity: .24; line-height: 1;
}
.stage-hint .st {
  font-size: clamp(.54rem, 1.4vw, .64rem);
  font-weight: 700; color: var(--tp); line-height: 1.8; text-align: center;
}

/* â”€â”€ æ•°å­—ã‚«ãƒ¼ãƒ‰ â”€â”€ */
.ncard {
  position: absolute;
  background: linear-gradient(145deg, var(--card-a), var(--card-b));
  border-radius: clamp(9px, 2vw, 13px);
  padding: clamp(5px,1.2vw,8px) clamp(9px,2.2vw,12px) clamp(5px,1.2vw,8px) clamp(6px,1.6vw,9px);
  min-width: clamp(58px, 13vw, 76px);
  box-shadow: 0 3px 0 var(--card-sh), 0 4px 10px rgba(0,30,20,.26);
  cursor: grab; user-select: none; touch-action: none;
  display: flex; align-items: center; gap: 3px;
  z-index: 10; transition: box-shadow .1s, transform .1s;
}
.ncard.dragging {
  cursor: grabbing;
  box-shadow: 0 6px 0 var(--card-sh), 0 10px 24px rgba(0,30,20,.38);
  transform: scale(1.07) rotate(-1.5deg); z-index: 80;
}
.ncard.enter   { animation: cIn  .3s cubic-bezier(.34,1.56,.64,1); }
.ncard.leaving { animation: cOut .17s ease-in forwards; }
@keyframes cIn  { from { transform:scale(.3) translateY(16px); opacity:0; } to { transform:scale(1); opacity:1; } }
@keyframes cOut { to   { transform:scale(.4); opacity:0; } }
.clbl { font-size: clamp(.4rem,.9vw,.5rem); font-weight:900; color:rgba(255,255,255,.5); letter-spacing:.06em; white-space:nowrap; }
.cval { font-size: clamp(.88rem,2.2vw,1.1rem); font-weight:900; color:#fff; letter-spacing:-.02em; white-space:nowrap; flex:1; text-align:right; }
.cdel {
  width:15px; height:15px; flex-shrink:0;
  background:rgba(255,255,255,.18); border:none; border-radius:50%;
  color:rgba(255,255,255,.78); font-size:.5rem; font-weight:900;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  line-height:1; transition:background .12s;
}
.cdel:hover { background:rgba(210,45,25,.52); }

/* ã‚«ãƒ¼ãƒ‰æšæ•°ãƒãƒƒã‚¸ */
.card-count {
  position:absolute; top:9px; right:10px; display:none;
  background:rgba(0,93,77,.15); border-radius:20px; padding:2px 9px;
  font-size:clamp(.5rem,1.2vw,.6rem); font-weight:900; color:var(--tm);
  letter-spacing:.05em; pointer-events:none; z-index:5;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   é›†è¨ˆçµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.result-overlay {
  position:absolute; inset:0;
  background:rgba(208,244,236,.94);
  backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
  border-radius:inherit;
  display:flex; flex-direction:column; justify-content:center;
  padding:clamp(10px,2.5vw,16px);
  z-index:200; opacity:0; pointer-events:none; transform:scale(.94);
  transition:opacity .24s ease, transform .24s cubic-bezier(.34,1.3,.64,1);
}
.result-overlay.show { opacity:1; pointer-events:auto; transform:scale(1); }
.ro-label {
  font-size:clamp(.44rem,1.1vw,.54rem); font-weight:900; letter-spacing:.18em;
  text-transform:uppercase; color:var(--tm); opacity:.5; margin-bottom:3px;
}
.ro-formula {
  font-size:clamp(.64rem,1.7vw,.8rem); font-weight:700; color:var(--tm);
  line-height:1.7; word-break:break-all; overflow-y:auto; max-height:34%;
}
.ro-formula .pl { color:var(--brand-mid); font-weight:900; margin:0 2px; }
.ro-total {
  font-size:clamp(1.4rem,4.5vw,2rem); font-weight:900; color:var(--td);
  text-align:right; letter-spacing:-.03em;
  border-top:1.5px solid rgba(0,93,77,.14);
  padding-top:4px; margin-top:4px; line-height:1;
}
.ro-close {
  margin-top:6px; display:block; width:100%;
  background:rgba(0,93,77,.09); border:none; border-radius:clamp(6px,1.5vw,9px);
  padding:clamp(4px,1vh,6px); font-family:var(--font);
  font-size:clamp(.54rem,1.4vw,.66rem); font-weight:800; color:var(--tm);
  cursor:pointer; transition:background .13s;
}
.ro-close:hover { background:rgba(0,93,77,.2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼
   C(--btn) | disp(1fr) | Î£(--btn)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ctrl {
  display: grid;
  grid-template-columns: var(--btn) 1fr var(--btn);
  gap: var(--gap);
  align-items: center;
  flex-shrink: 0;
}

/* ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ */
.disp {
  background: var(--disp-bg);
  border: 2px solid var(--disp-bd);
  border-radius: clamp(10px,2vw,16px);
  height: var(--btn);
  padding: 4px clamp(10px,2.2vw,14px);
  display: flex; flex-direction: column;
  justify-content: center; align-items: flex-end;
  overflow: hidden;
  cursor: grab; user-select: none; touch-action: none;
  transition: transform .12s, box-shadow .12s, border-color .13s;
  min-width: 0;
}
.disp:hover  { border-color: var(--brand-mid); box-shadow: 0 0 0 3px rgba(0,93,77,.1); }
.disp.lift   { cursor:grabbing; transform:scale(1.03) translateY(-3px); box-shadow:0 9px 22px rgba(0,30,20,.24); border-color:var(--brand); }
.d-expr {
  font-size: clamp(.46rem,1.2vw,.58rem); font-weight:600; color:var(--tp);
  min-height:10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%;
}
.d-num {
  font-size: clamp(1.3rem,4vw,1.8rem); font-weight:900; color:var(--td);
  letter-spacing:-.03em; white-space:nowrap; overflow:hidden;
  text-overflow:ellipsis; max-width:100%; line-height:1.05; transition:font-size .1s;
}
.d-num.sm { font-size: clamp(1rem,3vw,1.35rem); }
.d-num.xs { font-size: clamp(.78rem,2.3vw,1rem); }
@keyframes dfl { 0%,100%{background:var(--disp-bg)} 40%{background:#78D8CC} }
.disp.flash { animation:dfl .36s ease; }

/* ã‚´ãƒ¼ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ */
.ghost-card {
  position:fixed; pointer-events:none; z-index:9999;
  background:linear-gradient(145deg,var(--card-a),var(--card-b));
  border-radius:clamp(9px,2vw,13px); padding:clamp(5px,1.2vw,8px) clamp(9px,2.2vw,12px);
  font-family:var(--font); font-size:clamp(.88rem,2.2vw,1.1rem); font-weight:900; color:#fff;
  box-shadow:0 7px 18px rgba(0,30,20,.4); transform:scale(1.06) rotate(-2deg); opacity:.87; white-space:nowrap;
}
.stage.drop-ready {
  border-color:rgba(0,93,77,.46);
  background:linear-gradient(138deg,#B4E8E0,#9CDDD4);
  box-shadow:inset 0 0 14px rgba(0,93,77,.1);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ãƒœã‚¿ãƒ³
   ç›´å¾„ = --btnï¼ˆã‚³ãƒ³ãƒ†ãƒŠå¹…ã‹ã‚‰é€†ç®—ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
  border:none; border-radius:50%;
  width:var(--btn); height:var(--btn);
  font-family:var(--font); font-weight:800;
  cursor:pointer;
  display:flex; justify-content:center; align-items:center;
  margin:0 auto; user-select:none; flex-shrink:0;
  transition:transform .08s ease, box-shadow .08s ease;
}
.btn:active { transform:scale(.86) translateY(2px); }

/* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚‚btnã«é€£å‹• */
.bn  { background:linear-gradient(170deg,var(--bn-a),var(--bn-b)); color:#fff; font-size:calc(var(--btn)*.38); box-shadow:0 4px 0 var(--bn-sh),0 5px 12px rgba(0,30,20,.3); }
.bn:active  { box-shadow:0 1px 0 var(--bn-sh); }
.bop { background:var(--op-bg); color:var(--op-tx); font-size:calc(var(--btn)*.34); border:2px solid var(--op-bd); box-shadow:0 3px 0 #88C0B8,0 4px 8px rgba(0,0,0,.06); }
.bop:active { box-shadow:0 1px 0 #88C0B8; }
.bu  { background:linear-gradient(170deg,var(--ut-a),var(--ut-b)); color:#fff; font-size:calc(var(--btn)*.24); box-shadow:0 3px 0 var(--ut-sh),0 4px 8px rgba(0,30,20,.2); }
.bu:active  { box-shadow:0 1px 0 var(--ut-sh); }
.bc  { background:linear-gradient(170deg,var(--cl-a),#5A38B0); color:#fff; font-size:calc(var(--btn)*.28); box-shadow:0 4px 0 var(--cl-sh),0 5px 12px rgba(60,25,120,.32); }
.bc:active  { box-shadow:0 1px 0 var(--cl-sh); }
.beq { background:linear-gradient(170deg,var(--eq-a),#B82008); color:#fff; font-size:calc(var(--btn)*.36); box-shadow:0 4px 0 var(--eq-sh),0 5px 12px rgba(190,45,25,.34); }
.beq:active { box-shadow:0 1px 0 var(--eq-sh); }
.bga { background:linear-gradient(170deg,var(--ga-a),var(--ga-b)); color:#fff; box-shadow:0 4px 0 var(--ga-sh),0 5px 12px rgba(0,25,16,.36); }
.bga:active { box-shadow:0 1px 0 var(--ga-sh); }
.btax { background:linear-gradient(170deg,var(--tax-a),var(--tax-b)); color:#fff; font-size:calc(var(--btn)*.19); letter-spacing:.03em; box-shadow:0 3px 0 var(--tax-sh),0 4px 9px rgba(0,30,20,.22); }
.btax:active { box-shadow:0 1px 0 var(--tax-sh); }

/* é›†è¨ˆãƒœã‚¿ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ */
.gather-icon {
  display:flex; flex-direction:column; align-items:center; gap:0;
  pointer-events:none; line-height:1;
}
.gi-label  { font-size:calc(var(--btn)*.14); font-weight:900; color:rgba(255,255,255,.75); letter-spacing:.05em; }
.gi-symbol { font-size:calc(var(--btn)*.38); font-weight:900; color:#fff; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰
   5åˆ— Ã— --btnã€gapé€£å‹•ã€ä¸­å¤®æƒãˆ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.kpad {
  display: grid;
  grid-template-columns: repeat(5, var(--btn));
  gap: var(--gap);
  justify-content: center;
  flex-shrink: 0;
}

/* ãƒãƒƒãƒ— */
@keyframes tpop { 0%{transform:scale(1)} 45%{transform:scale(1.1)} 100%{transform:scale(1)} }
</style>
</head>
<body>
<div class="calc">

  <p class="app-title">Green Gathering Calculator</p>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¸ -->
  <div class="stage" id="stage">
    <div class="stage-hint" id="stageHint">
      <span class="si">ğŸƒ</span>
      <span class="st">æ•°å­—ã‚’å…¥åŠ›ã—ã¦<br>ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚’<strong>ä¸Šã«ã‚¹ãƒ¯ã‚¤ãƒ—</strong>ã§ã‚«ãƒ¼ãƒ‰è¿½åŠ </span>
    </div>
    <div class="card-count" id="cardCount"><span id="cardCountNum">0</span> ä»¶</div>
    <div class="result-overlay" id="resultOverlay">
      <div class="ro-label">é›†è¨ˆçµæœ</div>
      <div class="ro-formula" id="roFormula"></div>
      <div class="ro-total"   id="roTotal"></div>
      <button class="ro-close" onclick="closeResult()">âœ• é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ -->
  <div class="ctrl">
    <button class="btn bc" onclick="clearAll()">C</button>
    <div class="disp" id="dispBox">
      <div class="d-expr" id="exprLine">&nbsp;</div>
      <div class="d-num"  id="numLine">0</div>
    </div>
    <button class="btn bga" onclick="gatherAll()" title="å…¨ã‚«ãƒ¼ãƒ‰ã‚’åˆè¨ˆ">
      <div class="gather-icon">
        <span class="gi-label">TOTAL</span>
        <span class="gi-symbol">Î£</span>
      </div>
    </button>
  </div>

  <!-- ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ -->
  <div class="kpad">
    <button class="btn bn"   onclick="inp('7')">7</button>
    <button class="btn bn"   onclick="inp('8')">8</button>
    <button class="btn bn"   onclick="inp('9')">9</button>
    <button class="btn bop"  onclick="setOp('Ã·')">Ã·</button>
    <button class="btn bu"   onclick="bspc()">âŒ«</button>

    <button class="btn bn"   onclick="inp('4')">4</button>
    <button class="btn bn"   onclick="inp('5')">5</button>
    <button class="btn bn"   onclick="inp('6')">6</button>
    <button class="btn bop"  onclick="setOp('Ã—')">Ã—</button>
    <button class="btn bu"   onclick="tglSign()">Â±</button>

    <button class="btn bn"   onclick="inp('1')">1</button>
    <button class="btn bn"   onclick="inp('2')">2</button>
    <button class="btn bn"   onclick="inp('3')">3</button>
    <button class="btn bop"  onclick="setOp('âˆ’')">âˆ’</button>
    <button class="btn bu"   onclick="pct()">%</button>

    <button class="btn bn"   onclick="inp('0')">0</button>
    <button class="btn bn"   onclick="inp('.')">.</button>
    <button class="btn beq"  onclick="calcOnly()">ï¼</button>
    <button class="btn bop"  onclick="setOp('ï¼‹')">ï¼‹</button>
    <button class="btn btax" onclick="doTax()">TAX</button>
  </div>

</div>
<script>
let cur='0',prev='',op=null,rst=false;
const NL=document.getElementById('numLine'),EL=document.getElementById('exprLine'),
      DB=document.getElementById('dispBox'),ST=document.getElementById('stage'),
      SH=document.getElementById('stageHint'),ROV=document.getElementById('resultOverlay'),
      ROF=document.getElementById('roFormula'),ROT=document.getElementById('roTotal'),
      CCB=document.getElementById('cardCount'),CCN=document.getElementById('cardCountNum');
let cards=[],cid=0;

function updD(v){
  const s=String(v);NL.textContent=s;NL.classList.remove('sm','xs');
  const l=s.replace(/[^0-9.]/g,'').length;
  if(l>12)NL.classList.add('xs');else if(l>8)NL.classList.add('sm');
}
function inp(ch){
  if(rst){cur='';rst=false;}
  if(cur==='0'&&ch!='.')cur='';
  if(ch==='.'&&cur.includes('.'))return;
  if(cur.replace('-','').length>=13)return;
  cur+=ch;if(!cur||cur==='-')cur='0';updD(cur);
}
function setOp(o){if(op&&!rst)calcOnly(true);prev=cur;op=o;EL.textContent=cur+' '+o;rst=true;}
function calcOnly(chain){
  if(!op)return false;
  const p=parseFloat(prev),c=parseFloat(cur);
  if(isNaN(p)||isNaN(c))return false;
  let res;
  switch(op){case 'ï¼‹':res=p+c;break;case 'âˆ’':res=p-c;break;case 'Ã—':res=p*c;break;case 'Ã·':res=c===0?null:p/c;break;}
  if(res===null){EL.textContent='0é™¤ç®—ã‚¨ãƒ©ãƒ¼';cur='0';op=null;updD('Error');return false;}
  res=parseFloat(res.toPrecision(12));
  EL.textContent=prev+' '+op+' '+cur+' ï¼';
  prev=String(res);cur=String(res);op=chain?op:null;rst=!chain;updD(res);return res;
}
function clearAll(){cur='0';prev='';op=null;rst=false;updD('0');EL.textContent='';}
function bspc(){if(rst)return;cur=cur.slice(0,-1)||'0';updD(cur);}
function tglSign(){const n=parseFloat(cur);if(!isNaN(n)&&n!==0){cur=String(n*-1);updD(cur);}}
function pct(){const n=parseFloat(cur);if(!isNaN(n)){cur=String(n/100);updD(cur);}}
function doTax(){const n=parseFloat(cur);if(isNaN(n))return;const r=Math.floor(n*1.1);EL.textContent=cur+'Ã—1.1ï¼ˆç¨10%ï¼‰ï¼';cur=String(r);rst=true;updD(r);}
function fmt(v){if(Number.isInteger(v))return v.toLocaleString('ja-JP');return parseFloat(v.toPrecision(10)).toLocaleString('ja-JP',{maximumFractionDigits:6});}

function addCard(value){
  cid++;const id=cid,sw=ST.offsetWidth,cw=Math.max(58,fmt(value).length*12+44);
  let x,y;
  if(cards.length===0){x=Math.min(8+Math.random()*24,sw-cw-8);y=8;}
  else{const l=cards[cards.length-1];x=l.x+9+Math.random()*16-8;y=l.y+44+Math.random()*6-3;x=Math.max(4,Math.min(x,sw-cw-5));y=Math.max(4,Math.min(y,ST.clientHeight-42-5));}
  const el=document.createElement('div');
  el.className='ncard enter';
  el.innerHTML=`<span class="clbl">#${id}</span><span class="cval">${fmt(value)}</span><button class="cdel" onclick="removeCard(${id})">âœ•</button>`;
  el.style.left=x+'px';el.style.top=y+'px';
  ST.appendChild(el);
  const c={id,value,x,y,el};cards.push(c);
  el.addEventListener('animationend',()=>el.classList.remove('enter'),{once:true});
  makeDrag(el,c);updStage();closeResult();
}
function removeCard(id){
  const i=cards.findIndex(c=>c.id===id);if(i<0)return;
  const{el}=cards[i];el.classList.add('leaving');
  setTimeout(()=>{el.remove();cards.splice(i,1);updStage();},200);
}
function gatherAll(){
  if(cards.length===0)return;
  const cnt=cards.length,sum=cards.reduce((a,c)=>a+c.value,0),total=parseFloat(sum.toPrecision(12));
  let html='';cards.forEach((c,i)=>{if(i>0)html+=`<span class="pl"> ï¼‹ </span>`;html+=`<strong>${fmt(c.value)}</strong>`;});
  ROF.innerHTML=html+'<span class="pl"> ï¼ </span>';ROT.textContent=fmt(total);ROV.classList.add('show');
  cards.forEach(c=>c.el.classList.add('leaving'));
  setTimeout(()=>{cards.forEach(c=>c.el.remove());cards=[];updStage();},210);
  cur=String(total);rst=true;op=null;updD(fmt(total));EL.textContent=cnt+'ä»¶ åˆè¨ˆ ï¼';
}
function closeResult(){ROV.classList.remove('show');}
function updStage(){
  SH.style.opacity=cards.length===0?'1':'0';
  CCB.style.display=cards.length===0?'none':'block';
  if(cards.length)CCN.textContent=cards.length;
}

/* â”€â”€ ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ãƒ‰ãƒ©ãƒƒã‚° â”€â”€ */
(function(){
  let dragging=false,ghost=null,startY=0;
  const THR=28;
  function getVal(){if(op&&!rst){const r=calcOnly(false);return r===false?null:r;}const n=parseFloat(cur);return isNaN(n)?null:n;}
  function mkG(val){const g=document.createElement('div');g.className='ghost-card';g.textContent=fmt(val);document.body.appendChild(g);return g;}
  function mvG(cx,cy){if(!ghost)return;ghost.style.left=(cx-ghost.offsetWidth/2)+'px';ghost.style.top=(cy-ghost.offsetHeight/2)+'px';}
  function onSt(cx,cy){const r=ST.getBoundingClientRect();return cx>=r.left&&cx<=r.right&&cy>=r.top&&cy<=r.bottom;}
  function start(cx,cy){const v=getVal();if(v===null)return;dragging=true;startY=cy;DB.classList.add('lift');ghost=mkG(v);mvG(cx,cy);}
  function move(cx,cy){if(!dragging)return;mvG(cx,cy);ST.classList.toggle('drop-ready',onSt(cx,cy)||cy<startY-THR);}
  function end(cx,cy){
    if(!dragging)return;dragging=false;DB.classList.remove('lift');ST.classList.remove('drop-ready');
    if(ghost){ghost.remove();ghost=null;}
    if(onSt(cx,cy)||cy<startY-THR){const v=getVal();if(v!==null){addCard(v);cur='0';rst=false;op=null;updD('0');EL.textContent='';DB.classList.remove('flash');void DB.offsetWidth;DB.classList.add('flash');}}
  }
  DB.addEventListener('mousedown',e=>{e.preventDefault();start(e.clientX,e.clientY);});
  document.addEventListener('mousemove',e=>move(e.clientX,e.clientY));
  document.addEventListener('mouseup',e=>end(e.clientX,e.clientY));
  DB.addEventListener('touchstart',e=>{e.preventDefault();const t=e.touches[0];start(t.clientX,t.clientY);},{passive:false});
  document.addEventListener('touchmove',e=>{if(!dragging)return;e.preventDefault();const t=e.touches[0];move(t.clientX,t.clientY);},{passive:false});
  document.addEventListener('touchend',e=>{const t=e.changedTouches[0];end(t.clientX,t.clientY);});
})();

/* â”€â”€ ã‚«ãƒ¼ãƒ‰ãƒ‰ãƒ©ãƒƒã‚° â”€â”€ */
function makeDrag(el,card){
  let sx,sy,drag=false;
  el.addEventListener('mousedown',e=>{if(e.target.classList.contains('cdel'))return;e.preventDefault();drag=true;el.classList.add('dragging');const r=ST.getBoundingClientRect();sx=e.clientX-r.left-card.x;sy=e.clientY-r.top-card.y;front(el);});
  document.addEventListener('mousemove',e=>{if(!drag)return;mv(e.clientX,e.clientY,sx,sy,card,el);});
  document.addEventListener('mouseup',()=>{if(!drag)return;drag=false;el.classList.remove('dragging');});
  el.addEventListener('touchstart',e=>{if(e.target.classList.contains('cdel'))return;e.preventDefault();drag=true;el.classList.add('dragging');const r=ST.getBoundingClientRect(),t=e.touches[0];sx=t.clientX-r.left-card.x;sy=t.clientY-r.top-card.y;front(el);},{passive:false});
  document.addEventListener('touchmove',e=>{if(!drag)return;e.preventDefault();const t=e.touches[0];mv(t.clientX,t.clientY,sx,sy,card,el);},{passive:false});
  document.addEventListener('touchend',()=>{if(!drag)return;drag=false;el.classList.remove('dragging');});
}
function mv(cx,cy,sx,sy,card,el){
  const r=ST.getBoundingClientRect();
  let nx=cx-r.left-sx,ny=cy-r.top-sy;
  nx=Math.max(4,Math.min(nx,ST.clientWidth-el.offsetWidth-4));
  ny=Math.max(4,Math.min(ny,ST.clientHeight-el.offsetHeight-4));
  card.x=nx;card.y=ny;el.style.left=nx+'px';el.style.top=ny+'px';
}
function front(el){document.querySelectorAll('.ncard').forEach(c=>c.style.zIndex=10);el.style.zIndex=80;}

updD('0');
</script>
</body>
</html>
